<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Scrum Project Manager</title>

    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

	<script src="https://cdn.jsdelivr.net/npm/@trevoreyre/autocomplete-js@latest/dist/autocomplete.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@trevoreyre/autocomplete-js@latest/dist/style.css">
	<script src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.3.0/css/flag-icon.css">

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.3/dist/flatpickr.min.css">
	<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.3/dist/flatpickr.min.js"
		integrity="sha256-/irFIZmSo2CKXJ4rxHWfrI+yGJuI16Z005X/bENdpTY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/nonmin/jsoneditor.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/imask@latest/dist/imask.min.js"></script>
    <script>
    // Set the default CSS theme and icon library globally
    JSONEditor.defaults.options["theme"] = "spectre";
    JSONEditor.defaults.options["iconlib"] = "spectre";
	JSONEditor.defaults.options["disable_edit_json"] = 1;
	JSONEditor.defaults.options["disable_properties"] = 1;
	JSONEditor.defaults.options["required_by_default"] = 1;
    </script>
	<style>
	  .bar1 { fill: steelblue; }
	  .bar2 { fill: deepskyblue; }
	  .oddMS {
		background-color: #e8f7fc;
		text-align: center;
	  }
	  .evenMS {
		background-color: #fefdf8;
		text-align: center;
	  }
	  .plainbar:hover {fill: orange; }
	  .axis--x path { display: block; }
	  .greenline {
        fill: none;
        stroke: green;
        stroke-width: 3;
	  }
	  .redline {
        fill: none;
        stroke: red;
        stroke-width: 3;
	  }
	  .greendot {
        fill: green;
        stroke: green;
	  }
	  .reddot {
        fill: red;
        stroke: red;
	  }
	  div.tooltip {
		position: absolute;
		text-align: left;
		width: 90px;
		height: 30px;
		padding: 2px;
		font: 12px sans-serif;
		background: lightsteelblue;
		border: 0px;
		border-radius: 8px;
		pointer-events: none;
	  }
	  .devburndown { width: 150px; }
	</style>
	<script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
      .container {
        max-width:1600px;
        margin: 0 auto
      }
	  .tiny { background-color: '##5755d9' }
    </style>
  </head>
  <body>
    <div class='container'>
	  <div class='columns'>
        <div class='column col-md-12'>
		  <button id='load' class='btn btn-primary mr-2'>Load Project</button>
          <button id='save' class='btn btn-primary mr-2'>Save Project</button>
          <span id='valid_indicator' class='label'></span>  
        </div>
      </div>
	  <div id="dataentry">
		<!-- Read data from file -->
		<div id='dataread' class='columns' style="display: none;">
		  <br/><input type="file" onchange="readProjectFile(this)"><br/><br/>
		</div>
		<!-- Save data to file -->
		<div id="datasave" style="display: none;">
		  <br/><input id="projectfile" type="text" size="32">
		  <button id='savefile' class='tiny'>Save</button>
		  <br/>
		</div>
		<!-- Project editor -->
		<div class='columns'>
		  <div class='column col-md-12' id='editor_holder1'></div>
		</div>
	  </div>
    </div>
    
    <script>

// includeJS("https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js")
// includeCSS("https://pmk65.github.io/jedemov2/dist/examples/bloodhound.css")
// includeCSS("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.3.0/css/flag-icon.css")

	  window.JSONEditor.defaults.callbacks = {
		"autocomplete": {
		  "search_reqtId": function searchReqtID(requirement, input) {
			var ed = editor.getEditor('root.backlog.scope');
			if (!ed) return [];
			
			var reqtpath = requirement.path.match(/root.tracking.scope.[0-9]+/)[0];
			var description = editor.getEditor(reqtpath + ".description").getValue();
			if (description) {
			  var feature = ed.getValue().filter(r => r.description == description);
			  if (feature.length) {
			    return feature[0].feature;
			  }
			}
			var planned = editor.getEditor("root.tracking.scope")
			  .getValue().map(r => r.id);
			var data = ed.getValue().map(r => r.feature)
			  .filter(r => planned.filter(s => s == r).length == 0);
			return data.filter(function(item) {
			  return item.toLowerCase().startsWith(input.toLowerCase());
			});
		  },
		  "search_reqt": function search(requirement, input) {
			var ed = requirement.jsoneditor.getEditor('root.backlog.scope');
			if (!ed) return [];
			var reqtpath = requirement.path.match(/root.tracking.scope.[0-9]+/)[0];
			if (id = document.querySelector('[data-schemapath="' + reqtpath + '.id"] input').value) {
			  data = ed.getValue().filter(r => r.feature == id).map(r => r.description)
			}
			else {
			  planned = requirement.jsoneditor.getEditor("root.tracking.scope")
			    .getValue().map(r => r.description);
			  data = ed.getValue().map(r => r.description)
			    .filter(r => planned.filter(s => s == r).length == 0);
			}
			return data.filter(function(item) {
			  return item.toLowerCase().startsWith(input.toLowerCase());
			});
		  }
		}
	  };
	  window.JSONEditor.defaults.callbacks.template = {
	    "setBDWeeks": setBDWeeks,
	    "setMSStartDates": setMSStartDates,
		"dontChange": (j, e) => e.self,
		"enumDevTitleCB": (jseditor, e) => e.item.name,
		"enumDevValueCB": (jseditor, e) => e.item.name,
		"enumMSTitleCB": (jseditor, e) => e.item.milestone,
		"enumMSValueCB": (jseditor, e) => e.item.milestone,
		"enumFilterCB": (jseditor, e) => {
		  if (jseditor.path.endsWith('developer')) {
		    if (e.item.role == 'QA') return "";
			return e.item.name;
		  }
		  if (jseditor.path.endsWith('qa')) {
		    if (e.item.role != 'QA') return "";
			return e.item.name;
		  }
		  if (jseditor.key == 'milestone') {
		    return e.item.milestone;
		  }
		  return "";
		}
	  };

	  projectschema = {
        // Enable fetching schemas via ajax
        ajax: true,
        
        // The schema for the editor
        schema: {
		  "title": "Scrum Project Editor",
		  "type": "object",
		  "form_name_root": "scrumproject",
		  "format": "categories",
		  "options": {
			"disable_collapse": true,
			"compact": true
		  },
		  "properties": {
			"backlog": {
			  "type": "object",
			  "title": "Planning",
			  "options": {
				"disable_collapse": true,
				"compact": true
			  }
			},
			"bandwidth": {
			  "title": "Bandwidth",
			  "type": "object",
			  "id": "bandwidth",
			  "format": "grid-strict",
			  "options": {
				"disable_collapse": true,
				"compact": true
			  },
			  "properties": {
				"projectname": {
				  "title": "Project Name",
				  "type": "string",
				  "options": {
					"infoText": "Name of the project will default to the file name to be saved.",
					"grid_columns": 4
				  }
				},
				"startdate": {
				  "title": "Start Date",
				  "type": "string",
				  "format": "date",
				  "options": {
					"infoText": "Start date of first milestone of the project.",
					"grid_columns": 2,
					"grid_break": true,
					"flatpickr": {
					  "inlineHideInput": true,
					  "wrap": true,
					  "dateFormat": 'd/m/Y',
					  "enable": [
						function (date) { return (date.getDay() === 1)}
					  ],
					  "allowInput": true
					}
				  }
				},
				"enddate": {
				  "title": "End Date",
				  "type": "string",
				  "options": {
				    "hidden": true
				  }
				},
				"team": {
				  "title": "Team",
				  "type": "array",
				  "format": "table",
				  "uniqueItems": true,
				  "options": {
				    "grid_columns": 3,
					"disable_array_reorder": true
				  },
				  "items": {
					"title": "Team member",
					"type": "object",
					"properties": {
					  "name": {
						"title": "Name",
						"type": "string"
					  },
					  "role": {
						"title": "Role",
						"type": "string",
						"enum": [
						  "Lead",
						  "Developer",
						  "QA"
						],
						"default": "Developer"
					  }
					}
				  }
				},
				"milestones": {
				  "title": "Milestones",
				  "type": "array",
				  "id": "milestones",
				  "format": "tabs-top",
				  "options": {
				    "grid_columns": 6,
					"grid_break": true,
					"disable_array_reorder": true,
					"disable_array_delete": false,
					"disable_array_delete_all_rows": true,
					"disable_array_delete_last_row": true
				  },
				  "items": {
					"type": "object",
					"title": "Milestone",
					"id": "thisms",
					"headerTemplate": "M{{ i1 }}",
					"format": "grid-strict",
					"options": {
					  "disable_collapse": true,
					  "compact": true
					},
					"properties": {
					  "milestone": {
						"title": "Name",
						"type": "string",
						"options": {
						  "grid_columns": 1,
						  "hidden": true
						 }
					  },
					  "msstartdate": {
						"title": "Start",
						"type": "string",
						"options": {
						  "grid_columns": 2,
						}
					  },
					  "duration": {
						"title": "Weeks",
						"type": "integer",
						"options": {
						  "input_width": "40px",
						  "grid_columns": 2,
						  "grid_break": true
						},
						"default": 4
					  },
					  "capacity": {
						"title": "Capacity",
						"type": "array",
						"format": "table",
						"options": {
						  "disable_array_add": true,
						  "disable_array_delete": true,
						  "disable_array_reorder": true
						},
						"items": {
						  "title": "Developer",
						  "type": "object",
						  "properties": {
							"developer": {
							  "title": "Developer",
							  "type": "string",
							  "template": "dontChange"
							},
							"availability": {
							  "title": "Availabe %",
							  "type": "string",
							  "options": {
							    "input_width": "60px",
							    "imask": {
								  "mask": "val{%}",
								  "lazy": false,
								  "blocks": {
									"val": {
									  "mask": "Number",
									  "radix": "."
									}
								  }
								}
							  }
							},
							"vacation": {
							  "title": "Days off",
							  "type": "number",
							  "options": {
								"input_width": "40px"
							  }
							}
						  }
						}
					  }
					},
				  }
				},
				"blackoutweeks": {
				  "title": "Blackout weeks",
				  "type": "array",
				  "format": "table",
				  "uniqueItems": true,
				  "items": {
					"title": "Week",
					"type": "object",
					"properties": {
					  "reason": {
						"title": "Reason",
						"type": "string"
					  },
					  "week": {
						"title": "Week",
						"type": "string",
						"format": "date",
						"options": {
						  "flatpickr": {
							"inlineHideInput": true,
							"wrap": true,
							"dateFormat": 'd/m/Y',
							"enable": [
							  function (date) { return (date.getDay() === 1)}
							],
							"allowInput": true
						  }
						}
					  }
					}
				  }
				}
			  }
			},
			"tracking": {
			  "type": "object",
			  "title": "Tracking",
			  "options": {
				"disable_collapse": true,
				"compact": true
			  }
			},
			"graphs": {
			  "type": "object",
			  "title": "Graphs",
			  "options": {
				"disable_collapse": true,
				"compact": true
			  },
			  "properties": {
				"paper": {
				  "type": "info",
				  "description": "<div id='projectgraphs' style='display: none;'>Beep</div>"
				}
			  }
			},
			"settings": {
			  "type": "object",
			  "title": "Settings",
			  "options": {
				"disable_collapse": true,
				"compact": true
			  },
			  "properties": {
				"taborder": {
				  "title": "Tab order",
				  "type": "array",
				  "format": "table",
				  "options": {
					"disable_array_reorder": false,
					"disable_array_add": true,
					"disable_array_delete": true,
					"disable_array_delete_all_rows": true,
					"disable_array_delete_last_row": true
				  },
				  "items": {
					"title": "Tab",
					"type": "object",
					"properties": {
					  "tabname": {
						"type": "string",
						"template": "dontChange"
					  }
					},
					"options": {
					  "input_width": "150px"
					}
				  }
				}
			  }
			}
		  }
		}
	  };
	  
	  requirementschema = {
		schema: {
		  "title": "Planning",
		  "type": "object",
		  "options": {
			"compact": true,
			"disable_collapse": true
		  },
		  "properties": {
			"scope": {
			  "title": "Requirement",
			  "type": "object",
			  "format": "grid-strict",
			  "uniqueItems": true,
			  "options": {
				"disable_collapse": true
			  },
			  "properties": {
				"feature": {
				  "title": "ID",
				  "type": "string",
				  "required": true,
				  "options": {
					"grid_columns": 2
				  }
				},
				"description": {
				  "title": "Description",
				  "type": "string",
				  "format": "textarea",
				  "required": true,
				  "options": {
					"grid_columns": 4,
					"grid_break": true
				  }
				},
				"criticality": {
				  "title": "Importance",
				  "type": "string",
				  "enum": [
				    "Must",
					"High want",
					"Want",
					"Nice to have"
				  ],
				  "default": "High want",
				  "options": {
					"grid_columns": 2
				  }
				},
				"storypoints": {
				  "title": "Story point estimate",
				  "type": "number",
				  "default": 4,
				  "options": {
					"grid_columns": 2
				  }
				},
				"days": {
				  "title": "Estimated Days",
				  "type": "number",
				  "default": 4,
				  "options": {
					"grid_columns": 2
				  }
				}
			  }
			}
		  }
		}
	  };
	  
	  trackingschema = {
		schema: {
		  "title": "Scope",
		  "type": "object",
		  "format": "grid-strict",
		  "options": {
			"compact": true,
			"disable_collapse": true
		  },
		  "properties": {
			"scope": {
			  "title": "Feature",
			  "type": "object",
			  "format": "grid-strict",
			  "options" : {
				"disable_collapse": true,
				"grid_columns": 8
			  },
			  "properties": {
				"id": {
				  "title": "ID",
				  "type": "string",
				  "options": {
					"grid_columns": 3,
					"autocomplete": {
					  "search": "search_reqtId",
					  "autoSelect": true
					}
				  }
				},
				"description": {
				  "title": "Description",
				  "type": "string",
				  "format": "autocomplete",
				  "options": {
					"grid_columns": 6,
					"autocomplete": {
					  "search": "search_reqt",
					  "autoSelect": true
					}
				  }
				},
				"status": {
				  "title": "Status ",
				  "type": "string",
				  "options": {
					"grid_columns": 3,
					"grid_break": true
				  },
				  "enum": [
					"Not started",
					"In progress",
					"Impeded",
					"Obsolete",
					"Completed"
				  ],
				  "default": "Not started"
				},
				"milestone": {
				  "title": "Milestone",
				  "type": "string",
				  "options": {
					"grid_columns": 2
				  },
				  "watch": {
					"milestones": "root.bandwidth.milestones"
				  },
				  "enumSource": [{
					"source": "milestones",
					"filter": "enumFilterCB",
					"title": "enumMSTitleCB",
					"value": "enumMSValueCB"
				   }]
				  },
				"estimate": {
				  "title": "Estmate",
				  "type": "integer",
				  "options": {
					"grid_columns": 2
				  }
				},
				"resources": {
				  "title": "Team ",
				  "type": "object",
				  "options": {
					"grid_columns": 2
				  },
				  "properties": {
					"developer": {
					  "title": "Dev",
					  "type": "string",
					  "watch": {
						"team": "root.bandwidth.team"
					  },
					  "enumSource": [{
						"source": "team",
						"filter": "enumFilterCB",
						"title": "enumDevTitleCB",
						"value": "enumDevValueCB"
					  }]
					},
					"qa": {
					  "title": "QA",
					  "type": "string",
					  "watch": {
						"team": "root.bandwidth.team"
					  },
					  "enumSource": [{
						"source": "team",
						"filter": "enumFilterCB",
						"title": "enumDevTitleCB",
						"value": "enumDevValueCB"
					  }]
					}
				  }
				},
				"notes": {
				  "title": "Notes",
				  "type": "string",
				  "format": "textarea",
				  "required": false,
				  "options": {
					"grid_columns": 6
				  }
				}
			  }
			},
			"burndown": {
			  "title": "Burndown ",
			  "type": "object",
			  "options": {
				"collapsed": false,
				"compact": true,
				"disable_collapse": true,
				"grid_columns": 4
			  },
			  "properties": {
				"milestones": {
				  "title": "Milestones",
				  "type": "array",
				  "format": "tabs-top",
				  "options": {
					"compact": false,
					"disable_collapse": true,
					"disable_array_add": true,
					"disable_array_delete": true,
					"disable_array_delete_all_rows": true,
					"disable_array_delete_last_row": true,
					"disable_array_reorder": true
				  },
				  "items": {
					"title": "Milestone",
					"type": "object",
					"headerTemplate": "M{{ i1 }}",
					"format": "grid-strict",
					"options": {
					  "disable_collapse": true,
					  "compact": true
					},
					"properties": {
					  "milestone": {
						"title": "Name",
						"type": "string",
						"options": {
						  "hidden": true
						}
					  },
					  "remaining": {
						"title": "Remaining",
						"type": "array",
						"format": "table",
						"options": {
						  "compact": true,
						  "disable_collapse": true,
						  "disable_array_add": true,
						  "disable_array_delete": true,
						  "disable_array_delete_all_rows": true,
						  "disable_array_delete_last_row": true,
						  "disable_array_reorder": true
						},
						"items": {
						  "type": "object",
						  "format": "grid-strict",
						  "options": {
							"compact": true,
							"disable_collapse": true
						  },
						  "properties": {
							"date": {
							  "title": "Date",
							  "type": "string",
							  "template": "setBDWeeks",
							  "watch": {
								"msstart": "bandwidth.startdate",
								"msend": "bandwidth.enddate"
							  },
							  "options": {
								"compact": true,
								"input_width": "105px",
								"grid_columns": 4
							  }
							},
							"effort": {
							  "title": "Effort",
							  "type": "integer",
							  "options": {
								"compact": true,
								"input_width": "50px",
								"grid_columns": 4
							  }
							}
						  }
						}
					  }
					}
				  }
				}
			  }
			}
		  }
		}
	  };

	  // Initialize the editor
	  var project = {
		"backlog": { "scope": [] },
		"bandwidth": {
		  "projectname": "",
		  "startdate": "",
		  "enddate": "",
		  "team": [],
		  "milestones": [],
		  "blackoutweeks": []
		},
		"tracking": { "scope": [] },
		"settings": { "taborder": [
		  { "tabname": "Planning" },
		  { "tabname": "Bandwidth" },
		  { "tabname": "Tracking" },
		  { "tabname": "Graphs" },
		  { "tabname": "Settings" }
		]}
	  };
	  var editor, reqteditor, scheduleeditor;
	  editor = new JSONEditor(document.getElementById('editor_holder1'), projectschema);
	  editor.setValue(project);
	  trackingschema.schema.properties.bandwidth =
		projectschema.schema.properties.bandwidth;
	  trackingschema.schema.properties.bandwidth.options.hidden = true;
	  requirementTab();
	  trackingTab();
	  setupGraphDisplay();
	  var reqtcols = [ "feature", "description", "criticality",
	    "storypoints", "days", " " ];
	  var scopecols = [ "id", "description", "resources.developer",
	    "resources.qa", "status", "milestone", "estimate",
		"burndown", "notes", " "
	  ];

//--------------------- Backlog Tab --------------------------------------

	  // Create the UI for the "Planning" tab
	  function requirementTab() {
		// Setup requirements tab
		var reqtdiv = document.querySelector("div#Planning");
		reqtdiv.innerHTML = "<div id='reqteditor'></div>";
		// Add requirements button on top
		var rqttblcontrols = document.createElement("div");
		rqttblcontrols.id = "rqttblcontrols";
		rqttblcontrols.appendChild(makeButton("addrequirement",
		  "+Requirement"));
		reqtdiv.appendChild(rqttblcontrols);

		// Requirement form
		var formdiv = document.createElement("div");
		formdiv.id = "reqtform";
		formdiv.style.display = "none";
		var reqtform = document.createElement("div");
		reqtform.id = "requirement_editor";
		reqtform.classList.add("column");
		reqtform.classList.add("col-md-t12");

		// Controls over form
		var buttondiv = document.createElement("div");
		buttondiv.appendChild(makeButton("saverequirement", "Save & Close"));
		buttondiv.appendChild(makeButton("saveandaddreqt", "Save & Add"));
		buttondiv.appendChild(makeButton("cancelrequirement", "Cancel"));
		buttondiv.appendChild(makeButton("clearrequirement", "Clear"));
		
		// Arrange the parts of the page - button rows, form, list
		formdiv.appendChild(buttondiv);
		formdiv.appendChild(reqtform);
		reqtdiv.appendChild(formdiv);
		var reqttablediv = document.createElement("div");
		reqttablediv.id = "reqttablediv";
		reqtdiv.appendChild(reqttablediv);
		showRequirements(reqttablediv, "");
		reqteditor = new JSONEditor(reqtform, requirementschema);
	  }
	  
	  // Create the table of requirements that shows under the form
	  function showRequirements(reqttablediv, display) {
		reqttablediv.innerHTML = "";
		
		// Initialize the  table and headers
		reqttablediv.classList.add("table");
		reqttablediv.classList.add("table-scroll");
		reqttablediv.style["display"] = display;
		reqttablediv.style["min-width"] = "500px";
		reqttablediv.style["max-width"] = "1300px";

		var table = document.createElement("div");
		table.appendChild(addRequirementTableHeader());
		var tbody = document.createElement("tbody");
		tbody.id = "reqtlist";
		project.backlog.scope.forEach(s =>
		  tbody.appendChild(addReqtRow(s)));
		table.appendChild(tbody);
		reqttablediv.appendChild(table);
		updateRowMoveButtons("#reqthead", "#reqtlist");
	  }
	  
	  function addRequirementTableHeader() {
		var tr = document.createElement("tr");
		th = document.createElement("th");
		tr.appendChild(th);
		[ "ID", "Description", "Importance", "Story points", "Days", " " ].forEach(e => {
		  th = document.createElement("th");
		  th.innerText = e;
		  if (e == " ") th.style = "";
		  tr.appendChild(th);
		});

		var thead = document.createElement("thead");
		thead.id = "reqthead";
		thead.appendChild(tr);
		return thead;
	  }
	  
	  // Add requirements
	  function addReqtRow(s) {
		var tr = document.createElement("tr");
		var td = document.createElement("td");
		td.appendChild(addRequirementButton(s.feature));
		tr.appendChild(td);
		reqtcols.forEach(c => {
		  var td = document.createElement("td");
		  switch(c) {
			case " ":
			  jseditor = reqteditor.getEditor("root.scope");
			  button = jseditor.getButton('', 'delete', "Delete requirement");
			  button.addEventListener('click', e => {
				e.preventDefault();
				e.stopPropagation();
				deleteRequirement(s.feature);
			  });
			  button_holder = scheduleeditor.root.theme.getButtonHolder();
			  button_holder.appendChild(button);
			  td.appendChild(button_holder);
			  break;
			default:
			  td.innerText = s[c];
		  }
		  tr.appendChild(td);
		});
		return tr;
	  }
	  
	  // Set up the requirement editor with data of the requirement
	  function addRequirementButton(featureID) {
		jseditor = reqteditor.getEditor("root.scope");
		button = jseditor.getButton('', 'edit', "Edit requirement");
		button.addEventListener('click', e => {
		  e.preventDefault();
		  e.stopPropagation();
		  document.getElementById('addrequirement').click();
		  var feature = project.backlog.scope.find(f => f.feature == featureID);
		  var scope = {};
		  Object.keys(feature).forEach(p => scope[p] = feature[p]);
		  reqteditor.setValue({ "scope": scope });
		});
		button_holder = reqteditor.root.theme.getButtonHolder();
		button_holder.appendChild(button);
		return button_holder;
	  }
	  
	  function deleteRequirement(featureid) {
		if (window.confirm(`Do you really want to delete ${featureid}?`)
		  == false) return;
		if ((reqt = project.backlog.scope.map(r => r.feature)
		  .indexOf(featureid)) >= 0) {
		  document.getElementById("reqtlist").deleteRow(reqt);
		  project.backlog.scope.splice(reqt, 1);
		}
	  }

	  // Show form to enter a new requiremet/modify an existing one
	  document.getElementById('addrequirement').addEventListener('click', function() {
		  document.getElementById("reqtform").style.display = 'block';
		  document.getElementById("rqttblcontrols").style.display = 'none';
	  });
	  
	  // "Save & Add" button was clicked for requirement
	  document.getElementById('saveandaddreqt').addEventListener('click', function() {
		requirement = reqteditor.getValue();
		if (!requirement.scope.feature.length
		  || !requirement.scope.description.length) return;
		saveRequirement(requirement);
		reqteditor.destroy();
        reqteditor = new JSONEditor(document
		  .getElementById('requirement_editor'), requirementschema);
	  });
	  
	  // "Save & Close" button was clicked for requirement
	  document.getElementById('saverequirement').addEventListener('click', function() {
		requirement = reqteditor.getValue();
		if (!requirement.scope.feature.length
		  || !requirement.scope.description.length) return;
		saveRequirement(requirement);
		document.getElementById("reqtform").style.display = "none";
		document.getElementById("rqttblcontrols").style.display = "";
		reqteditor.destroy();
        reqteditor = new JSONEditor(document
		  .getElementById('requirement_editor'), requirementschema);
	  });

	  // "Cancel" button was clicked
	  document.getElementById('cancelrequirement').addEventListener('click', function() {
		document.getElementById("reqtform").style.display = "none";
		document.getElementById("rqttblcontrols").style.display = "";
	  });
	  
	  // "Clear" button was clicked
	  document.getElementById('clearrequirement').addEventListener('click', function() {
		reqteditor.destroy();
        reqteditor = new JSONEditor(document
		  .getElementById('requirement_editor'), requirementschema);
	  });

	  // Save requirement in global project JSON and array of requirement
	  function saveRequirement(requirement) {
	    scope = project.backlog.scope;
		var i = scope.findIndex(s => s.feature == requirement.scope.feature);
		
		// If requirement already exists, update it
		if (i >= 0) {
		  scope[i] = requirement.scope;
		  var tr = document.getElementById("reqtlist")
			.querySelector("tr:nth-child(" + (i + 1) + ")");
		  tr.innerHTML = addReqtRow(scope[i]).innerHTML;
		}
		else { // add the requirement
		  scope.push(requirement.scope);
		  var scopelist = document.getElementById("reqtlist");
		  scopelist.appendChild(addReqtRow(requirement.scope));
		}
		updateRowMoveButtons("#reqthead", "#reqtlist");
	  }
	  
	  // Add the edit/delete control buttons for the requirement row
	  function addRequirementControlButtons(feature, reqtno, td) {
		// Add the edit button
		jseditor = reqteditor.getEditor("root.scope");
		button = jseditor.getButton('', 'edit', "Edit requirement");
		button.addEventListener('click', e => {
		  reqteditor.getEditor("root.scope")
		    .setValue(project.backlog.scope
		    .filter(r => r.feature == feature)[0]);
		  document.getElementById("reqttablediv").style.display = 'block';
		  document.getElementById("rqttblcontrols").style.display = 'none';
		});

		button_holder = reqteditor.root.theme.getButtonHolder();
		button_holder.appendChild(button);
		td.appendChild(button_holder);		
	  }


//--------------------- Tracking Tab ---------------------------------------------

	  // Create the "Tracking" tab UI
	  function trackingTab() {
		// Setup tracking tab
		var trackingdiv = document.querySelector("div#Tracking");
		trackingdiv.innerHTML = "<div id='scopeeditor'></div>";
		// Add scope button on top
		var scopetblcontrols = document.createElement("div");
		scopetblcontrols.id = "scopetblcontrols";
		scopetblcontrols.appendChild(makeButton("addscopetracker",
		  "+Scope"));
		trackingdiv.appendChild(scopetblcontrols);

		// Tracking form
		var formdiv = document.createElement("div");
		formdiv.id = "trackingform";
		formdiv.style.display = "none";
		var trackingform = document.createElement("div");
		trackingform.id = "tracking_editor";
		trackingform.classList.add("column");
		trackingform.classList.add("col-md-t12");
		
		// Controls over form
		var buttondiv = document.createElement("div");
		buttondiv.appendChild(makeButton("saveschedule", "Save & Close"));
		buttondiv.appendChild(makeButton("saveandaddschedule", "Save & Add"));
		buttondiv.appendChild(makeButton("cancelschedule", "Cancel"));
		buttondiv.appendChild(makeButton("clearschedule", "Clear"));
		
		formdiv.appendChild(buttondiv);
		formdiv.appendChild(trackingform);
		trackingdiv.appendChild(formdiv);
		var scopetablediv = document.createElement("div");
		scopetablediv.id = "scopetablediv";
		trackingdiv.appendChild(scopetablediv);
		initScheduleEditor();
		showProjectSchedule();
	  }
	  
	  function initScheduleEditor() {
		scheduleeditor = new JSONEditor(document
		  .getElementById('tracking_editor'), trackingschema);
		scheduleeditor.getEditor("root.burndown")
		  .setValue(getBurndownShells());
		scheduleeditor.getEditor("root.bandwidth")
		  .setValue(editor.getEditor("root.bandwidth").getValue());
	  }
	  
	  function showProjectSchedule() {
		var scopetablediv = document.getElementById("scopetablediv");
		scopetablediv.innerText = "";
		var scheduletable = document.createElement("table");
		scheduletable.id = "scheduletable";
		
		// Initialize the  table and headers
		scheduletable.classList.add("table");
		scheduletable.classList.add("table-scroll");
		scheduletable.style["max-width"] = "1600px";
		
		// Set up the head and body HTML tags
		var tbody = document.createElement("tbody");
		tbody.id = "scopelist";
		var thead = document.createElement("thead");
		thead.id = "scopehead";
		thead.appendChild(addTrackingHeader1());
		thead.appendChild(addTrackingHeader2());
		
		// Add scope
		project.tracking.scope.forEach(s =>
		  tbody.appendChild(addTrackingRow(s)));
		scheduletable.appendChild(thead);
		scheduletable.appendChild(tbody);

		scopetablediv.appendChild(scheduletable);
		updateRowMoveButtons("#scopehead", "#scopelist");
	  }
	  
	  // Add tracking table headers
	  function addTrackingHeader1() {
		var tr = document.createElement("tr");
		th = document.createElement("th");
		th.setAttribute("rowSpan", 2);
		tr.appendChild(th);
		[ "ID", "Description", "Developer", "QA", "Status", "MS",
		  "Est.", "Burndown", "Notes" ].forEach(e => {
		  th = document.createElement("th");
		  switch (e) {
			case "Developer":
			  th.innerHTML = e + "<br/>";
			  th.id = "devnames";
			  th.setAttribute("rowSpan", 2);
			  th.appendChild(filterButton(
			    "Select developer", makeDevFilter, "#devnames"));
			  break;
			case "QA":
			  th.innerHTML = e + "<br/>";
			  th.id = "qanames";
			  th.setAttribute("rowSpan", 2);
			  th.appendChild(filterButton(
			    "Select QA", makeQAFilter, "#qanames"));
			  break;
			case "Status":
			  th.innerHTML = e + "<br/>";
			  th.id = "statusvals";
			  th.setAttribute("rowSpan", 2);
			  th.appendChild(filterButton(
			    "Select status", makeStatusFilter, "#statusvals"));
			  break;
			case "MS":
			  th.innerHTML = e + "<br/>";
			  th.id = "msselect";
			  th.setAttribute("rowSpan", 2);
			  th.appendChild(filterButton(
			    "Show milstones", makeMSFilter, "#msselect"));
			  break;
			case "Burndown":
			  var bgstyle = "oddMS";
			  project.bandwidth.milestones = editor
				.getEditor("root.bandwidth.milestones").getValue();
			  project.bandwidth.milestones.forEach(m => {
				th = document.createElement("th");
				th.classList.add(bgstyle);
				th.classList.add("ms" + m.milestone.substr(1));
				th.innerText = m.milestone;
				th.setAttribute("colSpan", m.duration);
				tr.appendChild(th);
				bgstyle = bgstyle == "oddMS" ? "evenMS" : "oddMS";
			  });
			  // Following column for 'delete; buttons
			  th = document.createElement("th");
			  th.id = "msfilter";
			  th.setAttribute("rowSpan", 2);
			  th.appendChild(filterButton(
			    "Show milstones", hideMSColumn, "#msfilter"));
			  tr.appendChild(th);
			  break;
			default:
			  th.innerText = e;
			  th.setAttribute("rowSpan", 2);
			  if (e == " ") th.style = "";
		  }
		  tr.appendChild(th);
		});
		return tr;
	  }
	  
	  function addTrackingHeader2() {
		var tweeks = document.createElement("tr");
		var bgstyle = "evenMS";
		for (var ms in project.bandwidth.milestones) {
		  bgstyle = bgstyle == "evenMS" ? "oddMS" : "evenMS";
		  var weeks = getMSWeeks(ms);
		  for (var w in weeks) {
			th = document.createElement("th");
			th.innerText = weeks[w];
			th.classList.add(bgstyle);
			th.classList.add("ms"
			  + project.bandwidth.milestones[ms].milestone.substr(1));
			tweeks.appendChild(th);
		  }
		}
		return tweeks;
	  }
	  	  
	  // Make a row for the feature to be tracked
	  function addTrackingRow(s) {
		var tr = document.createElement("tr");
		var td = document.createElement("td");
		td.appendChild(addEditFeatureButton(s.id));
		
		tr.appendChild(td);
		scopecols.forEach(c => {
		  var td = document.createElement("td");
		  switch(c) {
			case "notes":
			case "description":
			  td.style.whiteSpace = "normal";
			  td.style.maxWidth = "500px";
			  td.style.minWidth = "300px";
			  td.innerHTML = s[c];
			  break;
			case "resources.developer":
			  td.innerText = s.resources.developer;
			  break;
			case "resources.qa":
			  td.innerText = s.resources.qa;
			  break;
			case "burndown":
			  // Add effort burndown
			  var bgstyle = "evenMS";
			  for (var ms in project.bandwidth.milestones) {
				bgstyle = bgstyle == "evenMS" ? "oddMS" : "evenMS";
				getFeatureBDEffort(ms, s).forEach(w => {
				  var td = document.createElement("td");
				  td.innerText = w;
				  td.classList.add(bgstyle);
				  td.classList.add("ms" + (parseInt(ms) + 1));
				  tr.appendChild(td);
				});
			  }
			  
			  jseditor = scheduleeditor.getEditor("root.scope");
			  button = jseditor.getButton('', 'delete', "Delete requirement");
			  button.addEventListener('click', e => {
				e.preventDefault();
				e.stopPropagation();
				deleteFeature(s.id);
			  });
			  button_holder = scheduleeditor.root.theme.getButtonHolder();
			  button_holder.appendChild(button);
			  td.appendChild(button_holder);
			  tr.appendChild(td);
			  break;
			case " ":
			  break;
			default:
			  td.innerText = s[c];
		  }
		  if (c != "burndown") tr.appendChild(td);
		});
		return tr;
	  }

	  function filterButton(openHint, listMaker, locator) {
		var scheditor = scheduleeditor.getEditor("root.scope");
		if ((el = scheduleeditor.getEditor("root.scope")
		  .addproperty_holder.querySelector("button"))) el.remove();
		if ((el = scheduleeditor.getEditor("root.scope")
		  .addproperty_holder.querySelector("input"))) el.remove();
		var button = scheditor.getButton("", "expand", openHint);
		button.value = 0;
		var button_holder = scheduleeditor.root.theme.getHeaderButtonHolder();
		button_holder.appendChild(button);
		button.addEventListener('click', function(e) {
		  e.preventDefault();
		  e.stopPropagation();
		  this.value = this.value == "1" ? "0" : "1";
		  
		  var scheditor = scheduleeditor.getEditor("root.scope");
		  if (!scheditor.addproperty_holder)
			scheditor.addproperty_holder = jseditor.theme.getModal();
	      if (!scheditor.addproperty_list)
			scheditor.addproperty_list = document.createElement('div');
		  scheditor.addproperty_list.classList.add('property-selector');
		  if (scheditor.addproperty_input) {
		    delete scheditor.addproperty_input;
			document.querySelectorAll("[placeholder='Property name...']")
			  .forEach(e => { e.nextSibling.remove(); e.remove(); })
		  }
		  if (scheditor.addproperty_checkboxes)
			scheditor.addproperty_list.innerHTML = '';
		  scheditor.addproperty_checkboxes = {};

		  listMaker(scheditor, locator);
		  // Change the text/icon on the button
		  if (this.value == '1') {
			// Expand
			scheditor.setButtonText(this, '', 'collapse', 'Collapse');
			document.querySelector(locator).querySelector("div")
			  .style.display = "";
		  }
		  else {
			// Collapse
			scheditor.setButtonText(this, '', 'expand', 'Expand');
			document.querySelector(locator).querySelector("div")
			  .style.display = "none";
		  }
		}, false);
		return button_holder;
	  }
	  
	  // Setup the editor with a feature by mapping from stored form to UI form
	  function addEditFeatureButton(featureID) {
		jseditor = scheduleeditor.getEditor("root.scope");
		button = jseditor.getButton('', 'edit', "Edit requirement");
		button.addEventListener('click', e => {
		  e.preventDefault();
		  e.stopPropagation();
		  document.getElementById('addscopetracker').click();
		  var feature = project.tracking.scope.find(f => f.id == featureID);
		  var scope = {};
		  Object.keys(feature).filter(k => k != "burndown")
			.forEach(p => scope[p] = feature[p]);
		  scheduleeditor.setValue({
			"scope": scope,
			"burndown": feature.burndown,
			"bandwidth": editor.getEditor("root.bandwidth").getValue()
		  });
		  // WORKAROUND: Milestone does not get set first time without this
		  scheduleeditor.getEditor("root.scope.milestone")
		    .setValue(scope.milestone);
		});
		button_holder = scheduleeditor.root.theme.getButtonHolder();
		button_holder.appendChild(button);
		return button_holder;
	  }

	  // Delete the selected feature
	  function deleteFeature(featureid) {
		if (window.confirm(`Do you really want to delete ${featureid}?`)
		  == false) return;
		if ((reqt = project.tracking.scope.map(r => r.id)
		  .indexOf(featureid)) >= 0) {
		  document.getElementById("scopelist").deleteRow(reqt);
		  project.tracking.scope.splice(reqt, 1);
		}
	  }
	  
	  // Get the array of dd/mm weeks in the project
	  function getProjectWeeks() {
		if (!editor.getEditor("root.bandwidth.startdate").getValue().length
		  || !editor.getEditor("root.bandwidth.milestones").getValue().length)
		  return [];
		var startDate = ddmmyyyyToDate(editor.getEditor("root.bandwidth.startdate")
		  .getValue())
		return editor.getEditor("root.bandwidth.milestones").getValue().map(m => {
		  var w = []; 
		  for (var i = 0; i < m.duration; i++) {
			w.push(ddmm(startDate));
			startDate.setDate(startDate.getDate() + 7);
		  }
		  return w;
		}).reduce((a, b) => a.concat(b));
	  }
	  
	  // Get the array of dd/mm weeks in the MS
	  function getMSWeeks(ms) {
		if (!editor.getEditor("root.bandwidth.startdate").getValue().length
		  || !editor.getEditor("root.bandwidth.milestones").getValue().length)
		  return [];
		var msdate = getDateMSStart(ms);
		var msduration = project.bandwidth.milestones[ms].duration;
		var weeks = [];
		for (var w = 0; w < msduration; w++) {
		  weeks.push(ddmm(msdate));
		  msdate.setDate(msdate.getDate() + 7);
		}
		return weeks;
	  }
	  
	  // Get the array of burndown effort for MS
	  function getFeatureBDEffort(ms, s) {
		if (!s.burndown.milestones.length) return [];
		return s.burndown.milestones[ms].remaining.map(r => r.effort);
	  }

	  // Gets the array of visible requirements
	  function updateRowMoveButtons(theadid, tbodyid) {
		var visibleReqts = getVisibleReqts(tbodyid);
		if (!visibleReqts.length) return;
		var arrowColumn = visibleReqts[0].querySelectorAll("td").length;
		
		var reqt = visibleReqts[0]
		  .querySelector("td:nth-child(" + arrowColumn + ")");
		if (button = reqt.querySelector("[title='Move up']"))
		  button.parentNode.removeChild(button);
		
		reqt = visibleReqts[visibleReqts.length - 1]
		  .querySelector("td:nth-child(" + arrowColumn + ")");
		if (button = reqt.querySelector("[title='Move down']"))
		  button.parentNode.removeChild(button);
	  
		for (var i = 0; i < visibleReqts.length; i++) {
		  reqt = visibleReqts[i];
		  var td = reqt.querySelector(`td:nth-child(${arrowColumn})`)
		  if (i > 0 && !reqt.querySelector("[title='Move up']")) {
			button = jseditor.getButton('', 'moveup', "Move up");
			button.addEventListener('click',
			  e => reqtRowUp(e, theadid, tbodyid));
			button_holder = reqteditor.root.theme.getButtonHolder();
			button_holder.appendChild(button);
			td.appendChild(button_holder);
		  }
		  if (i < visibleReqts.length - 1
			&& !reqt.querySelector("[title='Move down']")) {
			button = jseditor.getButton('', 'movedown', "Move down");
			button.addEventListener('click', 
			  e => reqtRowDown(e, theadid, tbodyid));
			button_holder = reqteditor.root.theme.getButtonHolder();
			button_holder.appendChild(button);
			td.appendChild(button_holder);
		  }
		}
	  }
	  
	  // Get visible HTML rows
	  function getVisibleReqts(list) {
		var visibleReqts = [];
		document.querySelectorAll(list + ' tr:not([style*="display: none"])')
		  .forEach(t => visibleReqts.push(t));
		return visibleReqts;
	  }
	  
	  function reqtRowDown(e, listhead, list) {
		var tru = e.path[e.path
		  .findIndex(e => e.querySelector("td") != null)];
		var scope, id, trackingRow;
		switch (listhead) {
		  case "#scopehead":
			id = "id";
			scope = project.tracking.scope;
			trackingRow = addTrackingRow;
			break;
		  case "#reqthead":
			id = "feature";
			scope = project.backlog.scope;
			trackingRow = addReqtRow;
			break;
		}
		var visibleReqts = getVisibleReqts(list);
		var trl = visibleReqts[visibleReqts.indexOf(tru) + 1];
		var truScope = scope.filter(s =>
		  s[id] == tru.querySelector("td:nth-child(2)").innerText)[0];
		var trlScope = scope.filter(s =>
		  s[id] == trl.querySelector("td:nth-child(2)").innerText)[0];
		trl.innerHTML = trackingRow(truScope).innerHTML;
		tru.innerHTML = trackingRow(trlScope).innerHTML;
		if (listhead == "#scopehead")
		  for (var ms in project.bandwidth.milestones) {
		  display = document.querySelector(listhead + " .ms"
		    + (parseInt(ms) + 1)).style.display;
		  tru.querySelectorAll(".ms" + (parseInt(ms) + 1))
		    .forEach(s => s.style.display = display);
		  trl.querySelectorAll(".ms" + (parseInt(ms) + 1))
		    .forEach(s => s.style.display = display);
		}
		updateRowMoveButtons(listhead, list);
		scope[scope.findIndex(s => s[id] == trlScope.id)] = truScope;
		scope[scope.findIndex(s => s[id] == truScope.id)] = trlScope;
	  }
	  	  
	  function reqtRowUp(e, listhead, list) {
		var trl = e.path[e.path
		  .findIndex(e => e.querySelector("td") != null)];
		var scope, id, trackingRow;
		switch (listhead) {
		  case "#scopehead":
			id = "id";
			scope = project.tracking.scope;
			trackingRow = addTrackingRow;
			break;
		  case "#reqthead":
			id = "feature";
			scope = project.backlog.scope;
			trackingRow = addReqtRow;
			break;
		}
		var visibleReqts = getVisibleReqts(list);
		var tru = visibleReqts[visibleReqts.indexOf(trl) - 1];
		var truScope = scope.filter(s =>
		  s[id] == tru.querySelector("td:nth-child(2)").innerText)[0];
		var trlScope = scope.filter(s =>
		  s[id] == trl.querySelector("td:nth-child(2)").innerText)[0];
		trl.innerHTML = trackingRow(truScope).innerHTML;
		tru.innerHTML = trackingRow(trlScope).innerHTML;
		if (listhead == "#scopehead")
		  for (var ms in project.bandwidth.milestones) {
		  display = document.querySelector(listhead + " .ms"
		    + (parseInt(ms) + 1)).style.display;
		  tru.querySelectorAll(".ms" + (parseInt(ms) + 1))
		    .forEach(s => s.style.display = display);
		  trl.querySelectorAll(".ms" + (parseInt(ms) + 1))
		    .forEach(s => s.style.display = display);
		}
		updateRowMoveButtons(listhead, list);
		scope[scope.findIndex(s => s[id] == trlScope[id])] = truScope;
		scope[scope.findIndex(s => s[id] == truScope[id])] = trlScope;
	  }
	  
	  // Show form to enter a new scope item/modify an existing one
	  document.getElementById('addscopetracker').addEventListener('click', function() {
		  scheduleeditor.getEditor("root.burndown")
		    .setValue(getBurndownShells());
		  document.getElementById("trackingform").style.display = 'block';
		  document.getElementById("scopetblcontrols").style.display = 'none';
	  });
	  
	  // "Save & Add" button was clicked for schedule
	  document.getElementById('saveandaddschedule').addEventListener('click', function() {
		schedule = scheduleeditor.getValue();
		if (!schedule.scope.id.length || !schedule.scope.description.length) return;
		saveFeature(schedule);
		scheduleeditor.destroy();
		initScheduleEditor();
	  });
	  
	  // "Save & Close" button was clicked for schedule
	  document.getElementById('saveschedule').addEventListener('click', function() {
		schedule = scheduleeditor.getValue();
		if (!schedule.scope.id.length || !schedule.scope.description.length) {
		  window.alert('The "ID" and "Description" must be entered to save a new  requirement');
		  return;
		}
		document.getElementById("trackingform").style.display = 'none';
		document.getElementById("scopetablediv").style.display = 'block';
		document.getElementById("scopetblcontrols").style.display = 'block';
		saveFeature(schedule);
		scheduleeditor.destroy();
        initScheduleEditor();
	  });

	  // "Cancel" button was clicked
	  document.getElementById('cancelschedule').addEventListener('click', function() {
		document.getElementById("trackingform").style.display = 'none';
		document.getElementById("scopetablediv").style.display = 'block';
		document.getElementById("scopetblcontrols").style.display = 'block';
	  });
	  
	  // "Clear" button was clicked
	  document.getElementById('clearschedule').addEventListener('click', function() {
		scheduleeditor.destroy();
        initScheduleEditor();
	  });

	  // Save a schedule row in global project JSON and array of features
	  function saveFeature(requirement) {
		requirement.scope.burndown = requirement.burndown; // UI to storage change
		scope = project.tracking.scope;
		var i = scope.findIndex(s => s.id == requirement.scope.id);
		
		// If requirement already exists, update it
		if (i >= 0) {
		  scope[i] = requirement.scope;
		  var tr = document.getElementById("scopelist")
			.querySelector("tr:nth-child(" + (i + 1) + ")");
		  tr.innerHTML = addTrackingRow(scope[i]).innerHTML;
		}
		else { // Add the feature for development
		  scope.push(requirement.scope);
		  var scopelist = document.getElementById("scopelist");
		  scopelist.appendChild(addTrackingRow(requirement.scope));
		}
	  }
	  
	  function getBurndownShells() {
		var startdate = editor.getEditor("root.bandwidth.startdate").getValue();
		if (!startdate || !startdate.length) return false;
		var bdShell = { milestones: [] };
		var msdate = ddmmyyyyToDate(startdate);
		var milestones = editor.getValue().bandwidth.milestones;
		for (var ms in milestones) {
		  var milestone = { "milestone": "M" + (parseInt(ms) + 1), "remaining": [] };
		  for (var w = 0; w < milestones[ms].duration; w++) {
			milestone.remaining.push({
				"date": ddmm(msdate),
				"effort": 0 });
			msdate.setDate(msdate.getDate() + 7);
		  }
		  bdShell.milestones.push(milestone);
		}
		return bdShell;
	  }

//============================================================================

	  // Hook up the load button to display the load file form
	  document.getElementById('load').addEventListener('click', function() {
	    var dataread = document.getElementById("dataread");
		if (dataread.style.display === "none") {
		  dataread.style.display = "block";
		  document.getElementById('load').textContent = "Cancel Load";
		}
		else {
		  dataread.style.display = "none";
		  document.getElementById('load').textContent = "Load Project";
		}
	  });

	  function readProjectFile(input) {
		document.getElementById('load').textContent = "Load Project";
	    document.getElementById("dataread").style.display = "none";
	    let file = input.files[0];
		let reader = new FileReader();
		reader.readAsText(file);
		reader.onload = function() {
		  try {
			project = JSON.parse(reader.result);
		  }
		  catch (e) {
			window.alert("Eror reading JSON from file.");
			return;
		  }
		  project.graphs = {};
		  editor.getEditor("root.bandwidth").setValue(project.bandwidth);
		  editor.getEditor("root.settings").setValue(project.settings);
		  showRequirements(document.getElementById("reqttablediv", ""));
		  showProjectSchedule();
		  scheduleeditor.destroy();
          initScheduleEditor();
		  // Set order of tabs
		  setFirstTab();
		};
		reader.onerror = function() {
		  window.alert("File load failure");
		  console.log(reader.error);
		};
	  }
	  
	  // Hook up the save button
      document.getElementById('save').addEventListener('click', function() {
	    var datasave = document.getElementById("datasave");
		if (datasave.style.display === "none") {
		  datasave.style.display = "block";
		  var projectname = editor.getEditor('root.bandwidth.projectname').getValue();
		  if(!projectname || projectname == '') projectname = 'Project';
		  var dta = (new Date() + '').split(' ');
		  var tma = dta[4].split(':');
		  var dt = [dta[3], dta[1], dta[2], 'T', tma[0],tma[1], tma[2]].join('.');
		  document.getElementById('projectfile').value = projectname + '.' + dt + '.json';
		  document.getElementById('save').textContent = "Cancel Save";
		}
		else {
		  datasave.style.display = "none";
		  document.getElementById('save').textContent = "Save Project";
		}
	  });
	  
	  document.getElementById('savefile').addEventListener('click', function(e) {
		e.preventDefault();
        var d = new Date();
		var filename = document.getElementById('projectfile').value;
		var project = editor.getValue();
		project.bandwidth.milestones.forEach(m => delete m.dtstart);
		delete project.graphs;
		blob = new Blob([JSON.stringify(project, null, 2)], {
		  type: "application/json;charset=utf-8"
		});
		if (window.navigator && window.navigator.msSaveOrOpenBlob) {
		  window.navigator.msSaveOrOpenBlob(blob, filename);
		} else {
		  var a = document.createElement('a');
		  a.download = filename;
		  a.href = URL.createObjectURL(blob);
		  a.dataset.downloadurl = ['text/plain', a.download, a.href].join(':');
		  
		  a.dispatchEvent(new MouseEvent('click', {
			'view': window,
			'bubbles': true,
			'cancelable': false
		  }));
		}
		document.getElementById("datasave").style.display = "none";
      });

      // Hook up the validation indicator to update its 
      // status whenever the editor changes
      editor.on('change', function () {
	    // console.log('change function invoked');
        // Get an array of errors from the validator
        var errors = editor.validate();
        
        var indicator = document.getElementById('valid_indicator');
        
        // Not valid
        if(errors.length) {
          indicator.className = 'label alert';
          indicator.textContent = 'not valid';
        }
        // Valid
        else {
          indicator.className = 'label success';
          indicator.textContent = 'valid';
        };
      });

	  // When MS added to bandwidth or new requirement added in tracking 
	  editor.on('addRow', jseditor => {
		// console.log('addRow', (jseditor && jseditor.path) ? jseditor.path : "No/null parameter,", jseditor);
		// console.trace();
		
//******************** Adding new MS to Bandwidth
		// If new milestone added to bandwidth
		if (jseditor && jseditor.path && jseditor.path.match(/bandwidth\.milestones\.[0-9]+$/)) {
//-------------------- Add bandwidth configuration to MS
		  var ms = jseditor.path.match(/[0-9]+$/)[0];
		  var msName = 'M' + (parseInt(ms) + 1);
		 		  
		  // When adding Milestones, add all developers to bandwidth of all milestones
		  // if adding the first MS, create developer list 'manualy'
		  if (ms == '0') {
			var team = jseditor.parent.parent.editors.team.value.filter(d => d.role != "QA");
			var teamDevs = team.filter(a => a.name.length && a.role != 'QA');
			var msDevs = teamDevs.map(d => {
			  return {
			    "developer": d.name,
			    "availability": d.role == "Lead" ? 40: 80,
			    "vacation": 2
			  }
			});
			jseditor.editors.capacity.setValue(msDevs);
		  }
		  else { // Else copy capacity from first MS
			jseditor.editors.capacity.setValue(jseditor.parent.rows[0].value.capacity);
		  }
		  
		  // Initialize milestone start date from project start date
		  var startdate = jseditor.parent.parent.editors.startdate.getValue();
		  if (startdate) {
			var msdate = ddmmyyyyToDate(startdate);
			var milestones = jseditor.parent.getValue();
			for (var m in milestones) {
			   milestones[m].msstartdate = ddmm(msdate);
			   msdate.setDate(msdate.getDate() + (milestones[m].duration * 7));
			}
			jseditor.parent.setValue(milestones);
			jseditor.getChildEditors().msstartdate.disable();
			editor.getEditor("root.bandwidth.milestones")
			  .setValue(milestones);
			project.bandwidth.milestones = milestones;
		  }
		  editor.watch(`root.bandwidth.milestones.${ms}.duration`, () => {
			project.bandwidth.milestones[ms].duration = editor
			  .getEditor(`root.bandwidth.milestones.${ms}.duration`).getValue();
			realignMSDates(project.bandwidth.milestones);
			realignBurndown(project.bandwidth.milestones);
			showProjectSchedule();
		  });

//-------------------- Add MS to all requirements being tracked		  
		  // Initialize date array for MS; to be added to all requirements
		  var msSchedule = {
		    "milestone": msName,
			"remaining": []
		  };
		  var startdate = jseditor.parent.parent.editors.startdate.getValue();
		  var dtstart = ddmmyyyyToDate(startdate);
		  var milestones = jseditor.parent.parent.editors.milestones.getValue();
		  for (var m = 0; m < ms; m++) {
		    dtstart.setDate(dtstart.getDate() + (milestones[m].duration * 7));
		  }
		  
		  // Create a template of week dates. Effort comes later from each requirement
		  var duration = jseditor.parent.parent.editors.milestones.rows[ms].editors.duration.getValue();
		  for (var w = 0; w < duration; w++) {
		    msSchedule.remaining.push({
			  "date": ddmm(dtstart),
			  "effort": 0
			});
			dtstart.setDate(dtstart.getDate() + 7);
		  }
		  
		  // Add new MS to all requirements being tracked
		  var scope =  project.tracking.scope;
		  for (var r in scope) {
		    // If burndown does not contain MS, add MS
			if (!scope[r].burndown.milestones.filter(m => m.milestone == msName).length){
			  var effort = scope[r].estimate;
			  // If there was burndown, take effort from last week of last MS
			  if (effort > 0 && scope[r].burndown.milestones.length) {
			    var lastMS = scope[r].burndown.milestones.length - 1;
				var lastWk = scope[r].burndown.milestones[lastMS].remaining.length - 1;
				effort = scope[r].burndown.milestones[lastMS].remaining[lastWk].effort;
			  }
			  for (var wk = 0; wk < msSchedule.remaining.length; wk++) {
			    msSchedule.remaining[wk].effort = effort;
			  }
			  scope[r].burndown.milestones.push(msSchedule);
			}
		  }
		  var currentreqt = scheduleeditor.getValue();
		  var thisreqt = scope.filter(s => s.id == currentreqt.id);
		  if (currentreqt && thisreqt.length) { // If editing existing requirement
			scheduleeditor.setValue(thisreqt[0]);
		  }
		  setProjectEndDate();
		}
		
//******************** Automatically added MS to requirement in burndown
		if (jseditor && jseditor.path && jseditor.path.match(/tracking\.scope\.[0-9]+\.burndown\.milestones\.[0-9]+$/)) {
		  var scopeindex = parseInt(jseditor.path.match(/scope\.[0-9]*/)[0].match(/[0-9]+/)[0]);
console.log("Unexpected to be here", jseditor.path);
		  var msindex = parseInt(jseditor.path
		    .match(/milestones\.[0-9]*/)[0]
			.match(/[0-9]+/)[0]);
		  if (msindex > 0) { // Get last effort from last MS
			var lastMS = project.tracking.scope[scopeindex]
			  .burndown.milestones[msindex - 1];
			var lasteffort = lastMS.remaining[lastMS.remaining.length - 1].effort;
			var milestone = jseditor.getValue();
			for (var w = 0; w < milestone.remaining.length; w++) {
			  milestone.remaining[w].effort = lasteffort;
			}
			jseditor.setValue(milestone);
			highLightThisWeek();	
		  }
		}

//******************** When a row is added to a Tab other than the first one, the jseditor
// passed is null. This can happen is a new row is added either to the 'Tracking' or
// 'Planing' tabs, or when a team member is added
		if (!jseditor || !jseditor.path) {
		  var milestones = editor.getEditor('root.bandwidth.milestones').getValue();
		  if (!milestones || !milestones.length) return;
		  var scope = project.tracking.scope;
		  for (var r in scope) {
			if (scope[r].burndown.milestones.length < milestones.length) {
			  for (var i = scope[r].burndown.milestones.length; i < milestones.length; i++) {
				scope[r].burndown.milestones.push({
				  "milestone": "M" + (parseInt(i) + 1),
				  "remaining": remainingEffort(i)
				});
			  }
			}
		  }
		}
	  });
	  
	  editor.on('deleteRow', ed => {
		// console.log('deleteRow: Entering with', ed.path);		
		if (ed && ed.path) {
		  if (ed.path.match(/root.bandwidth.milestones.[0-9]+/)) {
			var startdate = editor.getEditor('root.bandwidth.startdate').getValue();
			if (!startdate || startdate.length == 0) return;
			setProjectEndDate();
			var milestones = editor.getEditor("root.bandwidth.milestones").getValue();
			var scope = editor.getEditor('root.tracking.scope').getValue();
			for (var m = 0; m < milestones.length; m++) {
			  var oldMS = milestones[m].milestone;
			  milestones[m].milestone = "M" + (m + 1);
			  scope.filter(s => s.milestone == oldMS).forEach(s => s.milestone = "M" + (m + 1));
			}
			editor.getEditor("root.bandwidth.milestones").setValue(milestones);
			project.bandwidth = editor.getEditor("root.bandwidth").getValue();
			realignBurndown(milestones);
			showProjectSchedule();
		  }
		}
	  });

	  // Set up column expansion / collision for scope table
	  editor.on('ready', function() {
		setFirstTab();
	  });

	  editor.watch('root.bandwidth.startdate', () => {
		var startdate = editor.getEditor("root.bandwidth.startdate").getValue();
		if (startdate == project.bandwidth.startdate) return;
		project.bandwidth.startdate = startdate;
		var msdate = ddmmyyyyToDate(startdate);
		project.bandwidth.milestones = editor
		  .getEditor("root.bandwidth.milestones").getValue();
		project.bandwidth.milestones.forEach(ms => {
		  ms.msstartdate = ddmm(msdate);
		  msdate.setDate(msdate.getDate() + (ms.duration * 7));
		});
		editor.getEditor("root.bandwidth.milestones")
		  .setValue(project.bandwidth.milestones);
		realignBurndown(project.bandwidth.milestones);
		showProjectSchedule();
	  });

	  // When resources change, sync all MS with resource list
	  editor.watch('root.bandwidth.team', () => {
	    // console.log('watch root.bandwidth.team');
		scheduleeditor.getEditor("root.bandwidth.team")
		  .setValue(editor.getEditor("root.bandwidth.team").getValue());
		let teamDevs = editor.getEditor("root.bandwidth.team")
			.getValue().filter(a => a.name.length && a.role != 'QA');
		var milestones = editor.getValue().bandwidth.milestones;
		
		// For every MS
		for (var ms in milestones) {
		  var capacity = milestones[ms].capacity;
		  var capacityKey = 'root.bandwidth.milestones.' + ms + '.capacity';
		  
		  // For all developers in team, check in this MS
		  for (var d in teamDevs) {
			// Developer found in team, but not in milestone capacity
			if (!capacity.filter(f => f.developer == teamDevs[d].name).length) {
			  var capacity = editor.getEditor(capacityKey).getValue();
			  capacity.push({ "developer": teamDevs[d].name, "availability": 80, "vacation": 2 });
			  editor.getEditor(capacityKey).setValue(capacity);
			}
		  }
		  
		  // Filter out non-developers in MS capacity
		  var toDelete = [];
		  for (var c in capacity) {
			if (!teamDevs.filter(f => f.name == capacity[c].developer).length > 0) {
			  toDelete.push(capacity[c].developer);
			}
		  }
		  for (var d in toDelete) {
		    capacity = capacity.filter(c => c.developer != toDelete[d]);
		  }
		  editor.getEditor(capacityKey).setValue(capacity);
		}
	  });

	  editor.watch('root.settings.taborder', setTabOrder);
	  	  
	  function realignMSDates(milestones) {
		var startdate = editor.getEditor("root.bandwidth.startdate").getValue();
		project.bandwidth.startdate = startdate;
		var msdate = ddmmyyyyToDate(startdate);
		milestones.forEach(ms => {
		  ms.msstartdate = ddmm(msdate);
		  msdate.setDate(msdate.getDate() + (ms.duration * 7));
		});
		editor.getEditor("root.bandwidth.milestones").setValue(milestones);
	  }
	  
	  function estimateChanged(requirement, r) {
		// console.log('Estimate changed for requirement[' + r + ']');
		if (!requirement) return;
		var estimate = project.tracking.scope[r].estimate;
		var burndown = project.tracking.scope[r].burndown;
		for (var m in burndown.milestones) {
			for (var w in burndown.milestones[m].remaining) {
			  burndown.milestones[m].remaining[w].effort = estimate;
			}
		}
		project.tracking.scope[r].burndown = burndown;
	  }
	  
	  // Highligt the remaining effort for the current week
	  function highLightThisWeek() {
		ms = getCurrentMS(project);
		if (ms < 0) return;
		
		today = new Date();
		weekno = Math.floor((today - getDateMSStart(ms)) / (7 * 24 * 3600 * 1000));
		milestone = project.bandwidth.milestones[ms];
		if (weekno >= milestone.duration) return;

		for (var j in project.tracking.scope) {
		  path = "root.tracking.scope." + j + ".burndown.milestones." + ms
			+ ".remaining." + weekno + ".effort";
		  effortinput = document.querySelector("[data-schemapath='" + path + "'] input");
		  if (effortinput) effortinput.style["backgroundColor"] = "yellow";
		}
	  }
	  
	  // Sets the order of tabs in the UI according to the stored preferences
	  function setTabOrder() {
		let formtabs = editor.getEditor("root.settings.taborder").getValue()
		  .map(t => t.tabname);
		let tabs = document.querySelector('#Bandwidth').parentElement;
		for (var t = formtabs.length; t > 0; t--) {
		  tabs.prepend(tabs.querySelector("#" + formtabs[t - 1]));
		}
	  }
	  
	  // Set first table
	  function setFirstTab() {
		if (editor.getEditor("root.settings.taborder").getValue().length == 0) {
		  editor.getEditor("root.settings.taborder").setValue([
			{ "tabname": "Planning" },
			{ "tabname": "Bandwidth" },
			{ "tabname": "Tracking" },
			{ "tabname": "Graphs" },
			{ "tabname": "Settings" }
		  ]);
		}
		var firsttab = editor.getEditor("root.settings.taborder")
		  .getValue()[0].tabname;
		setTabOrder();
		document.querySelector("#" + firsttab + " > a")
		  .dispatchEvent(new MouseEvent("click", {"view": window, "bubbles": true}));
	  }
	  
	  // Project end date set by adding the length of all MSs to start date
	  function setProjectEndDate() {
		var startdate = editor.getEditor('root.bandwidth.startdate').getValue();
		if (!startdate || startdate.length == 0) return;

		var projectlength = editor.getEditor("root.bandwidth.milestones").getValue()
		    .map(m => m.duration).reduce((a, b) => a + b);
		var projectstart = ddmmyyyyToDate(startdate);
		var projectend = new Date(projectstart);
		projectend.setDate(projectstart.getDate() + (projectlength * 7));
		editor.getEditor("root.bandwidth.enddate").setValue(ddmm(projectend));
	  }

	  // Toggle the MS rows visibility in the scope table
	  function toggler(e, pattern, button) {
		e.preventDefault();
		e.stopPropagation();
		// Toggle the value on the button
		button.value = button.value == '1' ? '0' : '1';

		// Change the text/icon on the button
		if (button.value == '1') {
		  // Expand
		  jseditor.setButtonText(button,'','collapse','Collapse All');
		}
		else {
		  // Collapse
		  jseditor.setButtonText(button,'','expand','Expand All');
		}
		
		// Loop through all jseditors
		Object.keys(editor.editors)
		  .filter(a => a.match(pattern))
		  .forEach(key => {
		  if (editor.editors.hasOwnProperty(key)) {
			var ed = editor.editors[key];
			
			if (['array', 'object'].indexOf(ed.schema.type) !== -1 && ed.editor_holder) {
			  if (button.value == '1') {
				// Expand
				ed.editor_holder.style.display = '';
				ed.collapsed = false;
				ed.setButtonText(ed.collapse_control,'','collapse','Collapse');
			  }
			  else {
				// Collapse
				ed.editor_holder.style.display = 'none';
				ed.collapsed = true;
				ed.setButtonText(ed.collapse_control,'','expand','Expand');
			  }
			}
		  }
		})
	  }
	  
	  // Add filters for requirement statuses
	  function addStatusCheckBox(rstatus, jseditor) {
	    const checkbox = jseditor.theme.getCheckbox();
		checkbox.style.width = 'auto';
		const label = jseditor.theme.getCheckboxLabel(rstatus);
		const control = jseditor.theme.getFormControl(label, checkbox);
		control.style.paddingBottom = control.style.marginBottom
		  = control.style.paddingTop = control.style.marginTop = 0;
		control.style.height = 'auto';
		jseditor.addstatus_list.appendChild(control);
		var editors = editor.getEditor('root.tracking.scope')
		  .rows.filter(r => editor.getEditor(r.path).getValue().status == rstatus)
		  .map(e => e.path);
		checkbox.checked = editors
		  .map(e => document.querySelector('[data-schemapath="' + e + '"]')
		    .style.display)
		  .filter(e => e == "none").length == 0;
		checkbox.addEventListener('change', () => {
		  if (checkbox.checked) {
			editors.forEach(e => document.querySelector('[data-schemapath="' + e + '"]')
			  .style.display = '');
		  }
		  else {
			editors.forEach(e => document.querySelector('[data-schemapath="' + e + '"]')
			  .style.display = 'none');
		  }
		});
		jseditor.addstatus_checkboxes[rstatus] = checkbox;
		return checkbox;
	  }
	  
	  // Common function for tracking table
	  function makeExecFilter(jseditor, column, featureSelector,
		ilist, head, list) {
		ilist.forEach(p => {
		  const checkbox = jseditor.theme.getCheckbox();
		  checkbox.style.width = 'auto';
		  const label = jseditor.theme.getCheckboxLabel(p);
		  const control = jseditor.theme.getFormControl(label, checkbox);
		  control.style.paddingBottom = control.style.marginBottom
			= control.style.paddingTop = control.style.marginTop = 0;
		  control.style.height = 'auto';
		  jseditor.addproperty_list.appendChild(control);
		  var features = featureSelector(p);
		  checkbox.checked = features.map(f => "tr:nth-child("
		    + (project.tracking.scope.map(f => f.id).indexOf(f) + 1) + ")")
		    .map(f => document.querySelector(list + " " + f).style.display)
		    .filter(e => e == "none").length == 0;
		  checkbox.addEventListener('change', () => {
		    if (checkbox.checked) {
			  features.map(f => "tr:nth-child("
				+ (project.tracking.scope.map(f => f.id).indexOf(f) + 1) + ")")
				.forEach(f => document.querySelector(list + " " + f)
				.style.display = "");
			}
			else {
			  features.map(f => "tr:nth-child("
				+ (project.tracking.scope.map(f => f.id).indexOf(f) + 1) + ")")
				.forEach(f => document.querySelector(list + " " + f)
				.style.display = "none");
			}
			updateRowMoveButtons(head, list);
		  });
		  jseditor.addproperty_checkboxes[p] = checkbox;
		});
		jseditor.addproperty_holder.appendChild(jseditor.addproperty_list);
		const spacer = document.createElement('div');
		spacer.style.clear = 'both';
		jseditor.addproperty_holder.appendChild(spacer);
		document.querySelector(column)
		  .insertAdjacentElement('beforeend', jseditor.addproperty_holder);
	  }
	  
	  function makeStatusFilter(jseditor, column) {
		makeExecFilter(jseditor, column, (p) => {
			return project.tracking.scope
			  .filter(s => s.status == p).map(s => s.id)
		  },
		  trackingschema.schema.properties.scope.properties.status.enum,
		  "#scopehead", "#scopelist");
	  }
	  
	  function makeDevFilter(jseditor, column) {
		makeExecFilter(jseditor, column, (p) => {
			return project.tracking.scope
			  .filter(s => s.resources.developer == p).map(s => s.id)
		  },
		  project.bandwidth.team
		  .filter(t => t.role != "QA").map(t => t.name),
		  "#scopehead", "#scopelist");
	  }
	  
	  function makeQAFilter(jseditor, column) {
		makeExecFilter(jseditor, column, (p) => {
			return project.tracking.scope
			  .filter(s => s.resources.qa == p).map(s => s.id)
		  }, project.bandwidth.team
		  .filter(t => t.role == "QA").map(t => t.name),
		  "#scopehead", "#scopelist");
	  }

	  function makeMSFilter(jseditor, column) {
		makeExecFilter(jseditor, column, (p) => {
			return project.tracking.scope
			  .filter(m => m.milestone == p).map(s => s.id)
		  }, project.bandwidth.milestones
		  .map(m => m.milestone),
		  "#scopehead", "#scopelist");
	  }

	  // Toggle column visibility
	  function toggleMSColumn(ms, jseditor) {
	    const checkbox = jseditor.theme.getCheckbox();
		checkbox.style.width = 'auto';
		const label = jseditor.theme.getCheckboxLabel(ms + " Milestone");
		const control = jseditor.theme.getFormControl(label, checkbox);
		control.style.paddingBottom = control.style.marginBottom
		  = control.style.paddingTop = control.style.marginTop = 0;
		control.style.height = 'auto';
		jseditor.addproperty_list.appendChild(control);
		var visible = [];
		document.getElementsByClassName("ms" + ms.substr(1))
		  .forEach(e => (e.style.display != "none") && visible.push(e));
		checkbox.checked = visible.length > 0;
		checkbox.addEventListener('change', () => {
		  if (checkbox.checked) {
			document.getElementsByClassName("ms" + ms.substr(1))
			  .forEach(e => e.style.display = "");
		  }
		  else {
			document.getElementsByClassName("ms" + ms.substr(1))
			  .forEach(e => e.style.display = "none");
		  }
		});
		jseditor.addproperty_checkboxes[ms] = checkbox;
	  }
	  
	  function hideMSColumn(jseditor, column) {
		editor.getEditor("root.bandwidth.milestones").getValue()
		  .map(m => m.milestone).forEach(ms => {
			toggleMSColumn(ms, jseditor);
		  });
		jseditor.addproperty_holder.appendChild(jseditor.addproperty_list);
		const spacer = document.createElement('div');
		spacer.style.clear = 'both';
		jseditor.addproperty_holder.appendChild(spacer);
		document.querySelector(column)
		  .insertAdjacentElement('beforeend', jseditor.addproperty_holder);
	  }

	  // Make list of values of requirement sttaus
	  function makeStatusList(column) {
		if (!jseditor.addstatus_holder)
		  jseditor.addstatus_holder = jseditor.theme.getModal();
	    if (!jseditor.addstatus_list)
		  jseditor.addstatus_list = document.createElement('div');
		jseditor.addstatus_list.classList.add('property-selector');
		if (jseditor.addstatus_checkboxes)
		  jseditor.addstatus_list.innerHTML = '';
		jseditor.addstatus_checkboxes = {};
		editor.schema.properties.tracking.properties.scope.items.properties.status.enum
		  .forEach(s => {
			addStatusCheckBox(s, jseditor);
		  });
		jseditor.addstatus_holder.appendChild(jseditor.addstatus_list);
		const spacer = document.createElement('div');
		spacer.style.clear = 'both';
		jseditor.addstatus_holder.appendChild(spacer);
		jseditor.container.querySelector(column)
		  .insertAdjacentElement('beforeend', jseditor.addstatus_holder);
	  }
  
	  // Get start Date() of MS 
	  function getDateMSStart(msnumber) {
	    var startdate = project.bandwidth.startdate;
		if (!startdate || !startdate.length) return false;
		var msdate = ddmmyyyyToDate(startdate);
		var milestones = project.bandwidth.milestones;
		for (var ms = 0; ms < msnumber; ms++) {
		  msdate.setDate(msdate.getDate() + (7 * milestones[ms].duration));
		}
		return msdate;
	  }

	  // Convert a Date() to ddmm
	  function ddmm(date) {
		return date.getDate() + '/' + (date.getMonth() + 1);
	  }
	  
	  // Converts dd/mm/yyyy string to Date(). Does not check for format match exactly
	  function ddmmyyyyToDate(indate) {
		var dateparts = indate.split('/');
		return new Date(dateparts[2] + '-' + dateparts[1] + '-' + dateparts[0]);
	  }
	  
	  // Get the effort burndown rows for the requirement
	  function remainingEffort(msnumber) {
		var remaining = [];
		var milestone = editor.getEditor('root.bandwidth.milestones.' + msnumber).getValue();
		// If miletstone has a start date, initialize dates of each week
		var dtstart = getDateMSStart(msnumber);
		if (dtstart) { // set start date of each week
		  for (var w = 0; w < milestone.duration; w++){
		    remaining.push({
			  "date": ddmm(dtstart),
			  "effort": 0
			});
			dtstart.setDate(dtstart.getDate() + 7);
		  }
		}
		else { // set empty date of each week
		  for (var w = 0; w < milestone.duration; w++){
		    remaining.push({
			  "date": "",
			  "effort": 0
			});
		  }
		}
		return remaining;
	  }
	  
	  // Set the start date of the MS in the Bandwidth tab
	  // Called when duration of any MS changes
	  function setMSStartDates(jseditor, e) {
		var startdate = editor.getEditor('root.bandwidth.startdate').getValue();
		if (!startdate || startdate.length == 0) return "";
		// thisMS is the one that changed
		var thisMS = parseInt(jseditor.path.split('.')[3]);
		var milestones = editor.getEditor('root.bandwidth.milestones').getValue();
		
		// If start date of project was changed
		if (thisMS == 0 && milestones.length && milestones[0].msstartdate &&
		  milestones[0].msstartdate != startdate.split('/')
		  .map(d => parseInt(d)).filter(i => i < 32).join("/")) {
		  realignBurndown(milestones);
		}
		// If a MS duration was changed
		// When a MS is deleted, this function gets (inexplicably) called with multiple instances
		// of a MS in the list
		if (milestones.length >= thisMS && milestones[thisMS] 
		  && allUnique(milestones)) {
		  milestones[thisMS].duration = e.msduration;
		  realignBurndown(milestones);
		  var enddate = getDateMSStart(0);
		  enddate.setDate(enddate.getDate() + milestones.map(m => m.duration)
		    .reduce((a, b) => a + b) * 7)
		  editor.getEditor("root.bandwidth.enddate").setValue(ddmm(enddate));
		}
		showProjectSchedule();
		return ddmm(getDateMSStart(thisMS));
	  }

	  // Checks that no milestone in a list is repeated
	  function allUnique(milestones) {
	    for (var m in milestones) {
		  if (milestones.filter(ms => ms.milestone == milestones[m].milestone).length > 1)
			return false;
		}
		return true;
	  }

	  // Setup the burndown data from scrath across all milestones
	  function realignBurndown(milestones) {
		var startdate = editor.getEditor('root.bandwidth.startdate').getValue();
		if (!startdate || startdate.length == 0 || milestones.length == 0) return;

		// Setup array of dates, based on start date and MS lengths
		var projectduration = milestones.map(m => m.duration).reduce((a, b) => a + b);
		var msdate = getDateMSStart(0);
		var weeks = [];
		for (var w = 0; w < projectduration; w++) {
		  weeks.push(ddmm(msdate));
		  msdate.setDate(msdate.getDate() + 7);
		}

		// For each requirement, get the existing burndown data
		var scope = project.tracking.scope
		  // Drop requirements that dont belong to an MS in list
		  .filter(s => milestones.filter(m => m.milestone == s.milestone).length);
		var burndown = [];
		scope.forEach(s => burndown.push({
		  "id": s.id,
		  "burndown": s.burndown.milestones
			.map(m => m.remaining)
			.reduce((a, b) => a.concat(b))
		}));

		// For each date in new schedule, create burndown for each requirement
		// with leading estimate, burndown data, or trailing last value
		scope.forEach(s => {
		  var effort = s.estimate;
		  var reqt = { "id": s.id, "remaining": [] };
		  // For each week in new schedule, copy old data
		  weeks.forEach(w => {
			// If week data existed for this week, use it, else use previos effort
			var oldbd = burndown.filter(r => r.id == s.id)[0]
			  .burndown.filter(b => b.date == w);
			if (oldbd.length > 0) effort = oldbd[0].effort;
			reqt.remaining.push({"date": w, "effort": effort});
		  });
		  // Copy burndown data back to requirement
		  var startweek = 0;
		  s.burndown.milestones = [];
		  for (var m in milestones) {
		    s.burndown.milestones.push({
			  "milestone": "M" + (parseInt(m) + 1),
			  "remaining": reqt.remaining
				.slice(startweek, milestones[m].duration + startweek)
			});
			startweek += milestones[m].duration;
		  }
		});
		project.tracking.scope = scope;
	  }
	  
	  function showBD(scope) {
		return scope.map(s => {
		  return {
			"id": s.id,
			"ms": s.milestone,
			"estimate": s.estimate,
			"burndown": s.burndown.milestones.map(m => m.remaining.map(r => r.effort)
			  .join(',')).reduce((a, b) => a + " : " + b)
		  }
		});
	  }
	  
	  // Now redundant, but kept to keep the field read only
	  function setBDWeeks (jseditor, e) {
		return jseditor.getValue();
	  }
	  	  
	  // Check for the various File API support.
	  if (window.File && window.FileReader && window.FileList && window.Blob) {
	    // Great success! All the File APIs are supported.
	  } else {
	    alert('The File APIs are not fully supported in this browser.');
	  }
	  
	  // Return the current MS 
	  function getCurrentMS(project) {
		// If no start date or no milestones, return -1
		if (!project.bandwidth.startdate || !project.bandwidth.milestones.length) return -1;
		var today = new Date();
		if (today <= getDateMSStart(0)) return 0;
		if (today >= getDateMSStart(project.bandwidth.milestones.length - 1))
		  return project.bandwidth.milestones.length - 1;
	    for (var m = 0; m < project.bandwidth.milestones.length - 1; m++) {
		  var thisms = getDateMSStart(m);
		  var nextms = getDateMSStart(m + 1);
		  if (today >= thisms && today < nextms) return m;
		}
		return -1;
	  }

	  // Capacity for the MS. Removes blackout weeks
	  function getMSCapacity(project, ms) {
		var blackoutweeks = project.bandwidth.blackoutweeks
		  .map(function(w) {
			p = w.week.split('/');
			return parseInt(p[0]) + '/' + parseInt(p[1]);
		  });
		var msweeks = remainingEffort(ms).map(w => w.date);
		var workingweeks = msweeks
		  .filter(w => !blackoutweeks.filter(b => b == w).length);
		var devdays = workingweeks.length * 5;
		var totalcapacity = 0;
		var capacity = project.bandwidth.milestones[ms].capacity;
		for (var c in capacity) {
		  devcapacity = Math.floor(((capacity[c].availability / 100) * devdays))
		    - capacity[c].vacation;
		  totalcapacity += devcapacity > 0 ? devcapacity : 0;
		}
		return totalcapacity;
	  }

	  // Gets the ddmm dates for the MS
	  function getWeeks(ms) {
		var duration = editor.getEditor("root.bandwidth.milestones." + ms).getValue().duration;
		var dt = getDateMSStart(ms);
		var weeks = [];
		for (var w = 0; w < duration; w++) {
		  weeks.push(ddmm(dt));
		  dt.setDate(dt.getDate() + 7);
		}
		return weeks;
	  }
	  
	  // Get the weekly burndown data for the MS, from sum of estimates to 0
	  function getMSBurndown(scope, ms) {
		var requirements = scope
		  .filter(w => w.milestone == 'M' + (parseInt(ms) + 1)
		    && w.status != 'Obsolete'); // All requirement in this MS
		if (requirements.length)
		  requirements = requirements.map(s => s.burndown.milestones[ms].remaining);
		
		var efforts = [{ 'week': 'Start', 'total': getMSEstimate(ms) }];
		var today = new Date();
		var weekno = Math.ceil((today - getDateMSStart(ms)) / (1000 * 3600 * 24 * 7));
		getWeeks(ms).forEach(w => {
		  var total = 0;
		  if (efforts.length <= weekno)
			for (var r in requirements) {
			  total += requirements[r].filter(wk => wk.date == w)[0].effort
			}
		  efforts.push({ 'week': w, 'total': total });
		});
		return efforts;
	  }
	  
	  // Get data for stacked burndown
	  function getMSFeatureBurndown(project, ms) {
		var requirements = project
		  .tracking
		  .scope
		  .filter(w => w.milestone == 'M' + (parseInt(ms) + 1)
		    && w.status != 'Obsolete');
		for (var r = 0; r < requirements.length; r++) {
		  if (!requirements[r].id) {
			requirements[r].id = 'M' + (parseInt(ms) + 1) + '-R' + r;
		  }
		}
		
		var reqts =  requirements.map(r => r.id);
		reqts.unshift("group");
		var weeks = getWeeks(ms);
		weeks.unshift("Start");
		var dataset = [reqts];
		var today = new Date();
		var weekno = Math.ceil((today - getDateMSStart(ms)) / (1000 * 3600 * 24 * 7));
		for (var w in weeks) {
		  var rlist = [];
		  for (var r in reqts) {
			if (r == 0) {
			  rlist.push(weeks[w]);
			}
			else {
			  if (w == 0) { // First column, use estimates
			    rlist.push(requirements[r - 1].estimate)
			  }
			  else {
				if (dataset.length <= weekno + 1) {
				  rlist.push(requirements[r - 1].burndown.milestones[ms]
					.remaining.filter(r => r.date == weeks[w])[0].effort);
				} 
				else {
				  rlist.push(0);
				}
			  }
			}
		  }
		  dataset.push(rlist);
		}
		return dataset.slice(1, dataset.length)
		  .map(d => {
			var v = {};
			for (var i in dataset[0]) {
			  v[dataset[0][i]] = d[i];
			}
			return v;
		  });
	  }
	  
	  function getDevMSBurndown(project, ms) {
		var requirements = project
		  .tracking
		  .scope
		  .filter(w => w.milestone == 'M' + (parseInt(ms) + 1)
		    && w.status != 'Obsolete');
		var weeks = getWeeks(ms);
		weeks.unshift("Start");
		var teamDevs = editor.getEditor("root.bandwidth.team")
			.getValue().filter(a => a.name.length && a.role != 'QA')
			.map(d => d.name);
		var dataset = [];
		var today = new Date();
		var weekno = Math.ceil((today - getDateMSStart(ms)) / (1000 * 3600 * 24 * 7));
		for (var w in weeks) {
		  var workweek = { "group": weeks[w] };
		  for(var d in teamDevs) {
			workweek[teamDevs[d]] = requirements
			  .filter(r => r.resources.developer == teamDevs[d]);
			if (weeks[w] == 'Start') {
			  if (workweek[teamDevs[d]].length) {
				workweek[teamDevs[d]] = workweek[teamDevs[d]]
				  .map(r => r.estimate)
				  .reduce((a, b) => a + b);
			  }
			  else {
				workweek[teamDevs[d]] = 0;
			  }
			}
			else {
			  if (workweek[teamDevs[d]].length) {
				if (dataset.length <= weekno) {
				  workweek[teamDevs[d]] = workweek[teamDevs[d]]
					.map(r => r.burndown.milestones[ms].remaining
					.filter(s => s.date == weeks[w])
					.map(r => r.effort)[0])
					.reduce((a, b) => a + b);
				}
				else {
				  workweek[teamDevs[d]] = 0;
				}
			  }
			  else {
				workweek[teamDevs[d]] = 0;
			  }
			}
		  }
		  dataset.push(workweek);
		}
		return dataset;
	  }
	  
	  function getProjectBurndown(project) {
	    var burndown = project
		  .tracking
		  .scope
		  .filter(w =>  w.status != 'Obsolete')
		  .map((s) => s.burndown.milestones.map(m => m.remaining).reduce((m1, m2) => m1.concat(m2)));
		var weeks = burndown[0].map(r => r.date);
		var totalEstimate = project
		  .tracking
		  .scope
		  .filter(w =>  w.status != 'Obsolete')
		  .map(r => r.estimate)
		  .reduce((s, e) => s + e);
		var efforts = [{ 'week': 'Start', 'total': totalEstimate }];
	  }

	  // Get the highest burndown remaining for this MS in all weeks
	  function getMaxRemainder(project, ms) {
		return Math.max(...(getMSBurndown(project.tracking.scope, ms).map(m => m.total)));
	  }

	  // Sum of estimates for all requirements in MS
	  function getMSEstimate(ms) {
		var requirements = project.tracking.scope
		  .filter(w => w.milestone == 'M' + (parseInt(ms) + 1));
		return requirements.length ?
		  requirements.map(r => r.estimate)
		  .reduce((t, e) => t + e) : 0;
	  }

	  function getRemaimingDays(project, ms, developer) {
		var today = new Date();
		var msstart = getDateMSStart(ms);
		var msend = new Date();
		var duration = project.bandwidth.milestones[ms].duration;
		msend.setDate(msstart.getDate() + duration * 7);
		// If the MS is already over
		if (today >= msend) return 0;
		// If the MS hasnt started, full capacity is left
		var capacity = project
		  .bandwidth
		  .milestones[ms]
		  .capacity.filter(c => c.developer == developer);
		if (today <= msstart) {
		  return (duration * 5) * (capacity[0].availability / 100) - capacity[0].vacation; 
		}
		// If MS is in progress, remaining effort in the MS
		return Math.floor((msend.getTime() - today.getTime()) / (msend.getTime() -  msstart.getTime())
		  * (duration * 5) * (capacity[0].availability / 100));
	  }

	  function getWorkingWeeks(project, ms) {
		var blackoutweeks = getBlackedOutWeeks(project);
		return remainingEffort(ms).map(w => w.date)
		  .filter(w => !blackoutweeks.filter(b => b == w).length);
	  }
	  
	  // Get dd/mm version of blacked out weeks
	  function getBlackedOutWeeks(project) {
		return project.bandwidth.blackoutweeks
		  .map(function(w) {
			p = w.week.split('/');
			return parseInt(p[0]) + '/' + parseInt(p[1]);
		  });
	  }

//----------------- Graphs --------------------------------------------
	  
	  function milestonebd() {
		var ms = getCurrentMS(project);
		if (ms < 0) return;
		var margin = {top: 20, right: 20, bottom: 30, left: 40},
		  width = 600,
		  height = 300;
		
		// Set up left and right screen halves
		var board = d3.select("#graph")
		  .append("div")
		  .style("width", '100%')
		  .style("height", '100%');
		// Select MS dropdown
		board.append("div")
		  .append("text")
		  .text("Milestone: ")
		  .append("select")
		  .style("width", '100%')
		  .attr("id", "selectMS")
		  .style("width", '50px')
		  .selectAll("milestones")
		  .data(project.bandwidth.milestones.map(m => m.milestone))
		  .enter()
		  .append("option")
		  .text(d => d)
		  .attr("value", d => parseInt(d.substring(1)) - 1);
		d3.select('#selectMS').property('value', ms);
		var leftGraph = board.append("div")
		  .attr("id", "leftGraph")
		  .style("width", "50%")
		  .style("height", "100%")
		  .style("float", "left");
		var rightGraph = board.append("div")
		  .attr("id", "rightGraph")
		  .style("margin-left", "50%")
		  .style("height", "100%");
		d3.select("#selectMS").on("change", function(d) {
          var ms = d3.select(this).property("value");
		  document.getElementById("leftGraph").textContent = '';
		  document.getElementById("rightGraph").textContent = '';
		  drawGraphs(project, ms);
		});
		
		function drawGraphs(project, ms) {
		  // Ymax is max of capacity or remaining burndown
		  ms = parseInt(ms);
		  var capacity = getMSCapacity(project, ms);
		  var maxremainder = getMaxRemainder(project, ms);
		  var ymax = Math.max(capacity, maxremainder);
		  var burndown = getMSBurndown(project.tracking.scope, ms);
		  var workingweeks = getWorkingWeeks(project, ms);

		  var duration = project.bandwidth.milestones[ms].duration;
		  var slope = capacity / workingweeks.length;
		  var blackoutweeks = getBlackedOutWeeks(project);
		  for (var i = 0; i < duration + 1; i++) {
			burndown[i].target = capacity;
			if (i < burndown.length - 1 && blackoutweeks
				.filter(w => w == burndown[i + 1].week).length == 0) {
				capacity -= slope;
			}
		  }

		  var xScale = d3.scaleBand()
			.rangeRound([0, width])
			.padding(0.2)
			.domain(burndown.map(b => b.week));
		  var yScale = d3.scaleLinear()
			.rangeRound([height, 0])
			.domain([0, ymax * 1.2]);

		  var svg = leftGraph.append("svg")
			.attr("width", "100%")
			.attr("height", height + margin.top + margin.bottom);
		  // Tooltip
		  var div = leftGraph.append("div")
			.attr("class", "tooltip")
			.style("opacity", 0);
		  // Chart title
		  svg.append("text")
			.attr("x", (width / 2))
			.attr("y", margin.top)
			.attr("text-anchor", "middle")
			.style("font-size", "20px")
			.style("text-decoration", "underline")
			.text("Mileston Burndown");
		  var g = svg.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		  // height of axis-x from bottom of graph
		  g.append("g")
			.attr("class", "axis axis--x")
			.attr("transform", "translate(0," + height + ")")
			.call(d3.axisBottom(xScale));
		  // axis-y
		  g.append("g")
			.attr("class", "axis axis--y")
			.call(d3.axisLeft(yScale));
		  var bar = g.selectAll("rect")
			.data(burndown)
			.enter().append("g");

		  // Bars
		  bar.append("rect")
			.attr("x", d => xScale(d.week))
			.attr("y", d => yScale(d.total))
			.attr("width", xScale.bandwidth())
			.attr("height", d => height - yScale(d.total))
			.attr("class", "plainbar bar1");
		  // labels on the bar chart
		  bar.append("text")
			.attr("dy", "1.3em")
			.attr("x", d => xScale(d.week) + xScale.bandwidth() / 2)
			.attr("y", d => yScale(d.total))
			.attr("text-anchor", "middle")
			.attr("font-family", "sans-serif")
			.attr("font-size", "11px")
			.attr("fill", "black")
			.text(d => d.total > 0 ? d.total : '');

		  // line charts
		  var stretch = 0.1 * burndown[0].target;
		  var greenline = d3.line()
			.x((d, i) => xScale(d.week) + xScale.bandwidth() / 2)
			.y(d => yScale(d.target));
		  bar.append("path")
			.attr("class", "greenline")
			.attr("d", greenline(burndown));
		  bar.append("circle")
			.attr("class", "greendot")
			.attr("cx", (d, i) => xScale(d.week) + xScale.bandwidth() / 2)
			.attr("cy", d => yScale(d.target))
			.attr("r", 3)
			.on("mouseover", function(event, d) {
				div.transition().duration(200).style("opacity", .9);
				div.html("Week: " + d.week + "<br/>Capacity: " + Math.floor(d.target))
					.style("left", (event.pageX) + "px")
					.style("top", (event.pageY + 28) + "px");
			})
			.on("mouseout", function(d) {
				div.transition().duration(500).style("opacity", 0);
			});
		  bar.append("text")
			.attr("dx", "1.3em")
			.attr("dy", "0.5em")
			.attr("x", (d, i) => xScale(d.week) + xScale.bandwidth() / 2)
			.attr("y", d => yScale(d.target))
			.attr("text-anchor", "middle")
			.attr("font-family", "sans-serif")
			.attr("font-size", "11px")
			.attr("fill", "black")
			.text(d => d.target > 0 ? Math.floor(d.target) : '');

		  var redline = d3.line()
			.x((d, i) => xScale(d.week) + xScale.bandwidth() / 2)
			.y(d => yScale(d.target + stretch));
		  bar.append("path")
			.attr("class", "redline")
			.attr("d", redline(burndown));
		  bar.append("circle")
			.attr("class", "reddot")
			.attr("cx", (d, i) => xScale(d.week) + xScale.bandwidth() / 2)
			.attr("cy", d => yScale(d.target + stretch))
			.attr("r", 3)
			.on("mouseover", function(event, d) {
				div.transition().duration(200).style("opacity", .9);
				div.html("Week: " + d.week + "<br/>Stretch: " + Math.floor(d.target + stretch))
					.style("left", (event.pageX) + "px")
					.style("top", (event.pageY - 28) + "px");
			})
			.on("mouseout", function(d) {
				div.transition().duration(500).style("opacity", 0);
			});
		  bar.append("text")
			.attr("dx", "1.3em")
			.attr("dy", "0.5em")
			.attr("x", (d, i) => xScale(d.week) + xScale.bandwidth() / 2)
			.attr("y", d => yScale(d.target + stretch))
			.attr("text-anchor", "middle")
			.attr("font-family", "sans-serif")
			.attr("font-size", "11px")
			.attr("fill", "black")
			.text(d => Math.floor(d.target + stretch));
//--------------------------------------------------------------------------------------------
		  var milestone = project.bandwidth.milestones[ms];
		  var capacity = milestone.capacity;
		  if (!capacity.length) return;
		  var scope = project.tracking.scope.filter(s => s.milestone == 'M' + (ms + 1));
		  var data = capacity.map(c => {
			return {
			  "Developer": c.developer,
			  "Planned availability": (milestone.duration * 5) * (c.availability / 100) - c.vacation,
			  "Assigned work": scope.filter(s => s.resources.developer == c.developer).length ?
				scope.filter(s => s.resources.developer == c.developer)
				  .map(r => r.estimate).reduce((t, r) => t + r) :
				0,
			  "Remaining days": getRemaimingDays(project, ms, c.developer),
			  "Remaining effort": scope
			    .filter(s => s.resources.developer == c.developer
				  && s.status != 'Complete' && s.status != 'Obsolete').length ?
					scope.filter(s => s.resources.developer == c.developer
					  &&s.status != 'Complete' && s.status != 'Obsolete')
					.map(r => r.estimate).reduce((t, r) => t + r) : 0,
			}
		  });
		  data.columns = Object.keys(data[0]);
		  data.y = "Days";

		  keys = data.columns.slice(1);
		  groupKey = data.columns[0];

		  xAxis = g => g
			.attr("transform", `translate(0,${height + margin.bottom -10})`)
			.call(d3.axisBottom(x0).tickSizeOuter(0));
		  yAxis = g => g
			.attr("transform", `translate(${margin.left},0)`)
			.call(d3.axisLeft(y).ticks(null, "s"))
			.call(g => g.select(".tick:last-of-type text").clone()
			  .attr("x", 3)
			  .attr("text-anchor", "start")
			  .attr("font-weight", "bold")
			  .text(data.y));

		  color = d3.scaleOrdinal()
			.range(["#6b486b", "#a05d56", "#d0743c", "#ff8c00", "#98abc5", "#8a89a6", "#7b6888"]);

		  x0 = d3.scaleBand()
			.domain(data.map(d => d[groupKey]))
			.rangeRound([margin.left, width - margin.right])
			.paddingInner(0.1);

		  x1 = d3.scaleBand()
			.domain(keys)
			.rangeRound([0, x0.bandwidth()])
			.padding(0.05);

		  y = d3.scaleLinear()
			.rangeRound([height + margin.bottom - 10, margin.top])
			.domain([0, d3.max(data, d => d3.max(keys, key => d[key])) + 10]).nice();

		  legend = svg => {
			const g = svg
			  .attr("transform", `translate(${width},0)`)
			  .attr("text-anchor", "end")
			  .attr("font-family", "sans-serif")
			  .attr("font-size", 10)
			  .selectAll("g")
			  .data(color.domain().slice().reverse())
			  .join("g")
			  .attr("transform", (d, i) => `translate(0,${i * 20})`);

			g.append("rect")
			  .attr("x", -19)
			  .attr("width", 19)
			  .attr("height", 19)
			  .attr("fill", color);

			g.append("text")
			  .attr("x", -24)
			  .attr("y", 9.5)
			  .attr("dy", "0.35em")
			  .text(d => d);
		  }

		  svg = rightGraph.append("svg")
			.attr("width", "100%")
			.attr("height", height + margin.top + margin.bottom);
		  div = rightGraph.append("div")
			.attr("class", "tooltip devburndown")
			.style("opacity", 0);
		  // Chart title
		  svg.append("text")
			.attr("x", (width / 2))
			.attr("y", margin.top)
			.attr("text-anchor", "middle")
			.style("font-size", "20px")
			.style("text-decoration", "underline")
			.text("Developer Load");
		  g = svg.append("g") // Whole graph boundary
			.attr("transform", "translate(" + margin.left + ", 0)");

		  bar = g.selectAll("rect")
			.data(data)
			.enter()
			.append("g")
			.attr("transform", d => `translate(${x0(d[groupKey])},0)`)

		  // Add bars
		  bar.selectAll("rect")
			.data(d => keys.map(key => ({
				key,
				value: d[key]
			})))
			.enter()
			.append("rect")
			.attr("x", d => x1(d.key))
			.attr("y", d => y(d.value))
			.attr("width", x1.bandwidth())
			.attr("height", d => y(0) - y(d.value))
			.attr("fill", d => color(d.key))
			.on("mouseover", function(event, d) {
				div.transition().duration(200).style("opacity", .9);
				div.html(d.key + ": " + d.value + " days")
					.style("left", (event.pageX) + "px")
					.style("top", (event.pageY - 128) + "px");
			})
			.on("mouseout", function(d) {
				div.transition().duration(500).style("opacity", 0);
			})

		  bar.selectAll("text")
			.data(d => keys.map(key => ({
				key,
				value: d[key]
			})))
			.enter()
			.append("text")
			.attr("dx", "1.4em")
			.attr("dy", "-0.3em")
			.attr("x", d => x1(d.key))
			.attr("y", d => y(d.value))
			.attr("text-anchor", "middle")
			.attr("font-family", "sans-serif")
			.attr("font-size", "11px")
			.attr("fill", "black")
			.text(d => d.value);

		  g.append("g")
			.call(xAxis);

		  g.append("g")
			.call(yAxis);

		  g.append("g")
			.call(legend);
		}
		drawGraphs(project, ms);
	  }
	
	  function projectbd() {
		var ms = getCurrentMS(project);
		if (ms < 0) return;
		
		var reqtburndown = project
		  .tracking
		  .scope
		  .filter(w =>  w.status != 'Obsolete') // All requirement in this MS
		  .map(s => (s.burndown.milestones
            .map(m => m.remaining))
            .reduce((a,b) => a.concat(b)));
		var weeks = reqtburndown[0].map(r => r.date);
		var burndown = [{
		  "date": "Start",
		  "effort": project
			.tracking
			.scope
			.filter(w =>  w.status != 'Obsolete')
			.reduce((a, b) => { return { "estimate": a.estimate + b.estimate } })
			.estimate
		}];
		var today = new Date();
		var weekno = Math.ceil((today - getDateMSStart(0)) / (1000 * 3600 * 24 * 7));
		for (w in weeks) {
		  if (w < weekno) {
			burndown.push(reqtburndown.map(r => r[w])
			  .reduce((a, b) => {
			    return { "date": b.date, "effort": a.effort + b.effort };
			  })
			)
		  }
		  else {
			burndown.push({ "date": weeks[w], "effort": 0 });
		  }
		}
		// Make burndown slope
		var capacity = 0;
		for (var m in project.bandwidth.milestones) {
		  capacity += getMSCapacity(project, m);
		}
		var blackoutweeks = getBlackedOutWeeks(project);
		var week = 0;
		burndown[week++].target = capacity;
		for (var ms in project.bandwidth.milestones) {
		  var mscapacity = getMSCapacity(project, ms);
		  var workingweeks = getWorkingWeeks(project, ms);
		  var slope = mscapacity / workingweeks.length;
		  var duration = project.bandwidth.milestones[ms].duration;
		  for (var w = 0; w < project.bandwidth.milestones[ms].duration; w++) {
			if (week > 0
			  && blackoutweeks.filter(w => w == burndown[week - 0].date).length == 0) {
			  capacity -= slope;
			}
			burndown[week++].target = capacity;
		  }
		}
		
		var ymax = burndown.reduce((a,b) => a.effort > b.effort ? a : b).effort;
		
		var margin = {top: 20, right: 20, bottom: 30, left: 40},
		  width = 900,
		  height = 300;
		  
		var board = d3.select("#graph")
		  .append("div")
		  .style("width", '100%')
		  .style("height", 500);
		  
		var xScale = d3.scaleBand()
		  .rangeRound([0, width])
		  .padding(0.2)
		  .domain(burndown.map(b => b.date));
		var yScale = d3.scaleLinear()
		  .rangeRound([height, 0])
		  .domain([0, ymax * 1.2]);
		  
		var svg = board.append("svg")
		  .attr("width", "100%")
		  .attr("height", height + margin.top + margin.bottom);
		// Tooltip
		var div = board.append("div")
		  .attr("class", "tooltip")
		  .style("opacity", 0);
		
		// Chart title
		svg.append("text")
		  .attr("x", (width / 2))
		  .attr("y", margin.top)
		  .attr("text-anchor", "middle")
		  .style("font-size", "20px")
		  .style("text-decoration", "underline")
		  .text("Project Burndown");
		
		var g = svg.append("g")
		  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		// height of axis-x from bottom of graph
		g.append("g")
		  .attr("class", "axis axis--x")
		  .attr("transform", "translate(0," + height + ")")
		  .call(d3.axisBottom(xScale));
		// axis-y
		g.append("g")
		  .attr("class", "axis axis--y")
		  .call(d3.axisLeft(yScale));
		  
		var bar = g.selectAll("rect")
		  .data(burndown)
		  .enter().append("g");

		// Bars
		bar.append("rect")
		  .attr("x", function(d) { return xScale(d.date); })
		  .attr("y", function(d) { return yScale(d.effort); })
		  .attr("width", xScale.bandwidth())
		  .attr("height", function(d) { return height - yScale(d.effort); })
		  .attr("class", "plainbar bar1");
		// labels on the bar chart
		bar.append("text")
		  .attr("dy", "1.3em")
		  .attr("x", function(d) { return xScale(d.date) + xScale.bandwidth() / 2; })
		  .attr("y", function(d) { return yScale(d.effort); })
		  .attr("text-anchor", "middle")
		  .attr("font-family", "sans-serif")
		  .attr("font-size", "11px")
		  .attr("fill", "black")
		  .text(function(d) { return d.effort > 0 ? d.effort : ''; });
		  
		// Ideal burndown line
		var greenline = d3.line()
		  .x(function(d, i) { return xScale(d.date) + xScale.bandwidth() / 2; })
		  .y(function(d) { return yScale(d.target); });
		bar.append("path")
		  .attr("class", "greenline")
		  .attr("d", greenline(burndown));
		bar.append("circle")
		  .attr("class", "greendot")
		  .attr("cx", function(d, i) { return xScale(d.date) + xScale.bandwidth() / 2; })
		  .attr("cy", function(d) { return yScale(d.target); })
		  .attr("r", 3	)
		  .on("mouseover", function(event,d) {
			div.transition().duration(200).style("opacity", .9);
			div.html("Week: " + d.date + "<br/>Capacity: " + Math.floor(d.target))
			  .style("left", (event.pageX) + "px")
			  .style("top", (event.pageY - 128) + "px");
			})
		  .on("mouseout", function(d) {
			div.transition().duration(500).style("opacity", 0);
		  });
		bar.append("text")
		  .attr("dx", "1.3em")
		  .attr("dy", "0.5em")
		  .attr("x", function(d, i) { return xScale(d.date) + xScale.bandwidth() / 2; })
		  .attr("y", function(d) { return yScale(d.target); })
		  .attr("text-anchor", "middle")
		  .attr("font-family", "sans-serif")
		  .attr("font-size", "11px")
		  .attr("fill", "black")
		  .text(function(d) { return d.target > 0 ? Math.floor(d.target) : ''; });
	  }

	  function splitBD() {
		var ms = getCurrentMS(project);
		if (ms < 0) return;
	
		var margin = {top: 20, right: 20, bottom: 30, left: 40},
		  width = 600,
		  height = 300;
		
		// Set up left and right screen halves
		var board = d3.select("#graph")
		  .append("div")
		  .style("width", '100%')
		  .style("height", 500);
		board.append("div")
		  .append("text")
		  .text("Milestone: ")
		  .append("select")
		  .style("width", '100%')
		  .attr("id", "selectMS")
		  .style("width", '50px')
		  .selectAll("milestones")
		  .data(project.bandwidth.milestones.map(m => m.milestone))
		  .enter()
		  .append("option")
		  .text(d => d)
		  .attr("value", d => parseInt(d.substring(1)) - 1);
		d3.select('#selectMS').property('value', ms);
		var leftGraph = board.append("div")
		  .attr("id", "leftGraph")
		  .style("width", "50%")
		  .style("height", "100%")
		  .style("float", "left");
		var rightGraph = board.append("div")
		  .attr("id", "rightGraph")
		  .style("margin-left", "50%")
		  .style("height", "100%");
		d3.select("#selectMS").on("change", function(d) {
          var ms = d3.select(this).property("value");
		  document.getElementById("leftGraph").textContent = '';
		  document.getElementById("rightGraph").textContent = '';
		  drawGraphs(project, ms);
		});
		
		var xScale, yScale, svg, div, g;
		
		function drawGraphs(project, ms) {
		  ms = parseInt(ms);
		  var fdata = getMSFeatureBurndown(project, ms);
		  drawPaper(project, ms, leftGraph, "Feature Burndown", fdata);
		  var udata = getDevMSBurndown(project, ms);
		  drawPaper(project, ms, rightGraph, "Developer Burndown", udata);
		}
		
		function drawPaper(project, ms, paper, title, data) {
		  var capacity = getMSCapacity(project, ms);
		  var maxremainder = getMaxRemainder(project, ms);
		  var ymax = Math.max(capacity, maxremainder);
		  var workingweeks = getWorkingWeeks(project, ms);
		  
		  var groups = data.map(d => d.group);
		  var subgroups = Object.keys(data[0]).filter(k => k != "group");

		  var color = d3.scaleOrdinal()
			.domain(subgroups)
			.range(['#e41a1c','#377eb8','#4daf4a']);

		  xScale = d3.scaleBand()
			.rangeRound([0, width])
			.padding(0.2)
			.domain(groups);
		  yScale = d3.scaleLinear()
			.rangeRound([height, 0])
			.domain([0, ymax * 1.2]);

		  svg = paper.append("svg")
			.attr("width", "100%")
			.attr("height", height + margin.top + margin.bottom);
		  // Tooltip
		  tooltip = paper.append("div")
			.attr("class", "tooltip")
			.style("width", 250)
			.style("opacity", 0);
		  // Chart title
		  svg.append("text")
			.attr("x", (width / 2))
			.attr("y", margin.top)
			.attr("text-anchor", "middle")
			.style("font-size", "20px")
			.style("text-decoration", "underline")
			.text(title);
		  g = svg.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		  // height of axis-x from bottom of graph
		  g.append("g")
			.attr("class", "axis axis--x")
			.attr("transform", "translate(0," + height + ")")
			.call(d3.axisBottom(xScale));
		  // axis-y
		  g.append("g")
			.attr("class", "axis axis--y")
			.call(d3.axisLeft(yScale));
		  // Legend
		  var legend = g.append("g")
			  .attr("transform", `translate(${width},0)`)
			  .attr("text-anchor", "end")
			  .attr("font-family", "sans-serif")
			  .attr("font-size", 10)
			  .selectAll("g")
			  .data(color.domain().slice())
			  .join("g")
			  .attr("transform", (d, i) => {
				return `translate(0,${i * 20})`;
			  });
			  
			legend.append("rect")
			  .attr("x", -19)
			  .attr("width", 19)
			  .attr("height", 19)
			  .attr("fill", color);

			legend.append("text")
			  .attr("x", -24)
			  .attr("y", 9.5)
			  .attr("dy", "0.35em")
			  .text(d => d);
		  
		  var stackedData = d3.stack()
			.keys(subgroups)
			(data)

		  // Show the bars
		  var bar = g.append("g")
			.selectAll("g")
			// Enter in the stack data = loop key per key = group per group
			.data(stackedData)
			.enter().append("g")
			  .attr("fill", d => color(d.key))
			  
		  var bar_enter = bar.selectAll("rect")
			.data(d => d)
			.enter().append("rect")
			  .attr("x", d => xScale(d.data.group))
			  .attr("y", d => yScale(d[1]))
			  .attr("height", d => yScale(d[0]) - yScale(d[1]))
			  .attr("width",xScale.bandwidth())
				
		  bar.on("mouseover", function(event, d) {
			tooltip.transition().duration(200).style("opacity", .9);
			var current = document.querySelectorAll(':hover');
			var info = current[current.length - 1].__data__;
			var remaining = info[1] - info[0];
			var tip = "<b>Dev.</b>"  + d.key + "<br><b>Remaining:</b> " + remaining;
			if (title.startsWith("Feature")) {
			  tip = "<b>Req#:</b> " + d.key + "<br><b>Remaining:</b> " + remaining;
			}
			tooltip.html(tip)
			  .style("left", (event.pageX) + "px")
			  .style("top", (event.pageY - 64) + "px");
			})
			.on("mouseout", function(d) {
			  tooltip.transition().duration(500).style("opacity", 0);			  // enter a second time = loop subgroup per subgroup to add all rectangles
			})
		}
		drawGraphs(project, ms);
	  }
	  
	  function makeButton(id, title) {
		var graphbutton = document.createElement("button");
		graphbutton.classList.add("btn");
		graphbutton.classList.add("btn-sm");
		graphbutton.classList.add("btn-primary");
		graphbutton.classList.add("mr-2");
		graphbutton.id = id;
		graphbutton.textContent = title;
		return graphbutton;
	  }
	  
	  function setupGraphDisplay() {
		var graphsdiv = document.querySelector("div#Graphs");
		var projectgraphs = document.createElement("div");
		projectgraphs.id = "projectgraphs";
		
		var graphs = document.createElement("div");
		graphs.classList.add("graphs");
		
		var column = document.createElement("div");
		column.appendChild(makeButton("milestonebd", "Milestone")); 
		column.appendChild(makeButton("projectbd", "Release")); 
		column.appendChild(makeButton("splitbd", "Feature/Developer"));
		
		var breakline = document.createElement("div");
		breakline.appendChild(document.createElement("br"));
		
		var grapharea = document.createElement("div");
		grapharea.id = "graph";
		grapharea.style.width = "100%";
		grapharea.style.height = "375px";
		
		graphs.appendChild(column);
		graphs.appendChild(breakline);
		graphs.appendChild(grapharea);
		projectgraphs.appendChild(graphs);
		graphsdiv.appendChild(projectgraphs);
	  }
	  
	  document.getElementById('Graphs').addEventListener('click', function() {
		  document.getElementById("graph").textContent = '';
		  milestonebd();
	  });
	  
	  document.getElementById('milestonebd').addEventListener('click', function() {
		  document.getElementById("graph").textContent = '';
		  milestonebd();
	  });
		  
	  document.getElementById('projectbd').addEventListener('click', function() {
		  document.getElementById("graph").textContent = '';
		  projectbd();
	  });
		  
	  document.getElementById('splitbd').addEventListener('click', function() {
		  document.getElementById("graph").textContent = '';
		  splitBD();
	  });
	  
    </script>
  </body>
</html>